<!-- Material Icons (like in your sample) -->
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />

<app-spinner [isLoading]="isLoading"></app-spinner>

<div class="body" *ngIf="!isLoading">

  <!-- ===== Filters (keep original controls/classes for SCSS) ===== -->
  <form [formGroup]="filterForm" dir="rtl" class="filter-form" style="gap:8px; align-items:flex-end;">
    <mat-form-field class="long-search-bar" appearance="outline" style="min-width:320px;">
      <mat-label class="filters" style="color: blue">חיפוש</mat-label>
      <input matInput formControlName="globalFilter" class="search-input" />
    </mat-form-field>

    <button type="button" mat-raised-button color="primary" class="custom-button" matTooltip="איפוס מסננים"
            (click)="resetFilters()">
      <i class="material-icons">refresh</i>
    </button>

    <img src="../../assets/excel.png" alt="Excel" (click)="exportToExcel()"
         class="download-icon" width="40" />

    <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; width:100%;">
      <mat-form-field>
        <mat-label>שנה</mat-label>
        <mat-select formControlName="YearFilter" multiple>
          <mat-option *ngFor="let year of uniqueYears" [value]="year">{{ year }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field>
        <mat-label>חודש</mat-label>
        <mat-select formControlName="MonthFilter" multiple>
          <mat-option *ngFor="let month of uniqueMonths" [value]="month">{{ month }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field>
        <mat-label>שבוע</mat-label>
        <mat-select formControlName="WeekFilter" multiple>
          <mat-option *ngFor="let week of uniqueWeeks" [value]="week">{{ week }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field>
        <mat-label>מחלקה בקבלה</mat-label>
        <mat-select formControlName="AdmissionDepartmentFilter" multiple>
          <mat-option *ngFor="let department of uniqueAdmissionDepartments" [value]="department">
            {{ department }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field>
        <mat-label>חדר הלם</mat-label>
        <mat-select formControlName="ShockRoomFilter" multiple>
          <mat-option *ngFor="let room of uniqueShockRooms" [value]="room">{{ room }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field>
        <mat-label>העברה למוסד אחר</mat-label>
        <mat-select formControlName="TransferFilter" multiple>
          <mat-option *ngFor="let transfer of uniqueTransfers" [value]="transfer">{{ transfer }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field>
        <mat-label>סיבת קבלה</mat-label>
        <mat-select formControlName="ReceiveCauseDesFilter" multiple>
          <mat-option *ngFor="let cause of uniqueReceiveCauses" [value]="cause">{{ cause }}</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- רלוונטי -->
      <div class="filter-radio-group" dir="rtl" style="display:flex; align-items:center; gap:10px;">
        <span class="filter-label">רלוונטי:</span>
        <mat-radio-group formControlName="relevantFilter" class="radio-group" style="display:flex; gap:12px;">
          <mat-radio-button value="לא עודכן">לא עודכן</mat-radio-button>
          <mat-radio-button value="1">כן</mat-radio-button>
          <mat-radio-button value="2">לא</mat-radio-button>
          <mat-radio-button value="">הכל</mat-radio-button>
        </mat-radio-group>
      </div>
    </div>
  </form>

  <!-- ===== Tabs (default = רשימת טראומה) ===== -->
  <mat-tab-group [selectedIndex]="0">
    <!-- ========== Tab 1: רשימת טראומה ========== -->
    <mat-tab label="רשימת טראומה">
      <!-- Wrap everything RTL so the scroll starts from the right -->
      <div class="trauma-container" dir="rtl">
    
        <!-- ===== TOP (VISIBLE) SCROLLBAR ===== -->
        <!-- The inner <div> width is synced from TS to match the table scrollWidth -->
        <div #topScroll class="table-scroll top-scroll" dir="rtl">
          <div></div>
        </div>
    
        <!-- ===== MAIN TABLE AREA (BOTTOM SCROLLBAR HIDDEN) ===== -->
        <div #bottomScroll class="table-scroll table-viewport hide-horizontal-scrollbar" dir="rtl">
          <table
  mat-table
  [dataSource]="dataSource"
  matSort
  [matSortDisabled]="sortDisabled"
  #mainSort="matSort"
  class="mat-elevation-z8 wide-table"
  dir="rtl">
    
            <!-- Toggle (NOT sortable) -->
            <ng-container matColumnDef="relevantToggle">
              <th mat-header-cell *matHeaderCellDef>רלוונטי</th>
              <td mat-cell *matCellDef="let element">
                <mat-checkbox
                  [checked]="element.relevant === 1"
                  (click)="$event.stopPropagation()"
                  (change)="onRelevantToggle(element, $event.checked)">
                </mat-checkbox>
              </td>
            </ng-container>
    
            <!-- Dynamic sortable columns -->
            <ng-container *ngFor="let column of displayedColumns">
              <ng-container *ngIf="column !== 'relevantToggle'" [matColumnDef]="column">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>
                  {{ columnHeaders[column] || column }}
                </th>
    
                <td mat-cell *matCellDef="let element" (click)="openDialog(element)">
                  <!-- textual 'relevant' column -->
                  <ng-container *ngIf="column === 'relevant'; else defaultColumn">
                    <span *ngIf="element.relevant === 1">כן</span>
                    <span *ngIf="element.relevant === 0">לא</span>
                    <span *ngIf="element.relevant === null">לא עודכן</span>
                  </ng-container>
    
                  <!-- other columns -->
                  <ng-template #defaultColumn>
                    <!-- date-like -->
                    <ng-container *ngIf="isDateColumn(column); else textCell">
                      <ng-container *ngIf="!isDefaultDate(element[column]); else emptyDate">
                        {{ element[column] | date:'dd/MM/yyyy HH:mm' }}
                      </ng-container>
                      <ng-template #emptyDate></ng-template>
                    </ng-container>
    
                    <!-- non-date -->
                    <ng-template #textCell>
                      {{ element[column] }}
                    </ng-template>
                  </ng-template>
                </td>
              </ng-container>
            </ng-container>
    
            <!-- header / rows -->
            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns; trackBy: trackByCase"></tr>
          </table>
        </div>
    
        <!-- Paginator -->
        <mat-paginator
          #mainPaginator
          [pageSize]="25"
          [pageSizeOptions]="[25,50,100]"
          showFirstLastButtons>
        </mat-paginator>
    
        <!-- ===== DIALOG (unchanged) ===== -->
        <div *ngIf="selectedPatient" class="dialog-backdrop">
          <div class="dialog-box large-dialog" style="max-width: 90vw; width: 90vw; max-height: 90vh; overflow: auto;">
            <h2>עריכת מטופל טראומה</h2>
    
            <form [formGroup]="editForms[selectedPatient.caseNumber]">
              <div class="columns-grid" dir="rtl">
                <ng-container *ngFor="let column of displayedColumns">
                  <ng-container *ngIf="column !== 'relevantToggle' && column !== 'remarks' && column !== 'relevant'">
                    <mat-form-field class="full-width">
                      <mat-label>{{ columnHeaders[column] || column }}</mat-label>
                      <input matInput [value]="formatDialogValue(column, selectedPatient[column])" readonly />
                    </mat-form-field>
                  </ng-container>
                </ng-container>
              </div>
    
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>הערות</mat-label>
                <textarea matInput formControlName="Remarks" rows="5" maxlength="2000"></textarea>
              </mat-form-field>
    
              <mat-label>רלוונטי</mat-label>
              <mat-radio-group formControlName="Relevant" class="radio-group">
                <mat-radio-button [value]="1">כן</mat-radio-button>
                <mat-radio-button [value]="0">לא</mat-radio-button>
              </mat-radio-group>
            </form>
    
            <div class="dialog-actions">
              <button type="button" mat-button (click)="closeDialog()">בטל</button>
              <button type="button" mat-button color="primary" (click)="saveEdit()">שמור</button>
            </div>
          </div>
        </div>
      </div>
    </mat-tab>
    
  <!-- ========== Tab 2: זמן מקבלה עד CT ========== -->
<mat-tab label="זמן מקבלה עד CT">
  <div class="trauma-container">
    <!-- Controls -->
    <div class="filter-form" dir="rtl" style="align-items:center; gap:12px;">
      <mat-form-field appearance="outline">
        <mat-label>קוד חדר הלם</mat-label>
        <mat-select [value]="shockRoomCode" (selectionChange)="onShockRoomCodeChange($event.value)">
          <mat-option value="V">V</mat-option>
          <mat-option value="X">X</mat-option>
        </mat-select>
      </mat-form-field>

      <div class="radio-group" style="display:flex; gap:8px;">
        <span style="align-self:center; margin-inline-end:8px;">תצוגה:</span>
        <button type="button" mat-stroked-button color="primary" [disabled]="ctGrouping==='year'" (click)="setCTGrouping('year')">שנה</button>
        <button type="button" mat-stroked-button color="primary" [disabled]="ctGrouping==='quarter'" (click)="setCTGrouping('quarter')">רבעון</button>
        <button type="button" mat-stroked-button color="primary" [disabled]="ctGrouping==='month'" (click)="setCTGrouping('month')">חודש</button>
      </div>

      <!-- Toggle graph/table -->
      <button type="button" mat-icon-button (click)="toggleCTGraph()" matTooltip="הצג/הסתר גרף">
        <mat-icon>{{ showCTGraph ? 'table_chart' : 'bar_chart' }}</mat-icon>
      </button>

      <img src="../../assets/excel.png" alt="Excel"
           (click)="exportAggCTToExcel()" class="download-icon" width="40" />
    </div>

    <!-- ===== GRAPH VIEW (only when toggled on) ===== -->
  <!-- ===== GRAPH VIEW (only when toggled on) ===== -->
<ng-container *ngIf="showCTGraph">
  <ng-container [ngSwitch]="ctGrouping">

    <!-- Year: percent chart (3 buckets) -->
    <app-trauma-graph
      *ngSwitchCase="'year'"
      [config]="ctBucketPercentChart"
      [height]="360"
      [showValues]="true"
      [percent]="true">
    </app-trauma-graph>

    <!-- Quarter: grouped by quarter (uses ctGraphData built in updateAggCT) -->
    <app-trauma-graph
    *ngSwitchCase="'quarter'"
    [config]="ctGraphData"
    [height]="360"
    [showValues]="true"
    [percent]="true">     <!-- NEW -->
  </app-trauma-graph>

    <!-- Month: split into 3 charts -->
    <ng-container *ngSwitchCase="'month'">
      <div class="three-grid">
        <app-trauma-graph [config]="ctMonthCharts?.under"   [height]="320" [showValues]="true"></app-trauma-graph>
        <app-trauma-graph [config]="ctMonthCharts?.between" [height]="320" [showValues]="true"></app-trauma-graph>
        <app-trauma-graph [config]="ctMonthCharts?.over"    [height]="320" [showValues]="true"></app-trauma-graph>
      </div>
    </ng-container>

  </ng-container>
</ng-container>


    <!-- ===== TABLE VIEW (only when graph is OFF) ===== -->
    <div class="table-responsive" *ngIf="!showCTGraph">
      <table mat-table [dataSource]="ctDataSource" matSort #ctSort="matSort" class="mat-elevation-z8 full-width">

        <ng-container matColumnDef="year">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>שנה</th>
          <td mat-cell *matCellDef="let r">{{ r.year }}</td>
        </ng-container>

        <ng-container matColumnDef="quarter">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>רבעון</th>
          <td mat-cell *matCellDef="let r">{{ r.quarter }}</td>
        </ng-container>

        <ng-container matColumnDef="month">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>חודש</th>
          <td mat-cell *matCellDef="let r">{{ r.month }}</td>
        </ng-container>

        <ng-container matColumnDef="under26">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>מתחת ל-26 דק׳</th>
          <td mat-cell *matCellDef="let r">{{ r.under26 }}</td>
        </ng-container>

        <ng-container matColumnDef="between26_60">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>בין 26 ל-60 דק׳</th>
          <td mat-cell *matCellDef="let r">{{ r.between26_60 }}</td>
        </ng-container>

        <ng-container matColumnDef="over60">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>מעל 60 דק׳</th>
          <td mat-cell *matCellDef="let r">{{ r.over60 }}</td>
        </ng-container>

        <ng-container matColumnDef="total">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>סה״כ מקרים</th>
          <td mat-cell *matCellDef="let r">{{ r.total }}</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="ctColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: ctColumns"></tr>
      </table>

      <mat-paginator #ctPaginator
                     [pageSize]="25"
                     [pageSizeOptions]="[10,25,50,100]"
                     showFirstLastButtons>
      </mat-paginator>
    </div>
  </div>
</mat-tab>

    

<!-- ========== Tab 3: זמן מקבלה עד ניתוחים ========== -->
<mat-tab label="זמן מקבלה עד ניתוחים">
  <div class="trauma-container">
    <!-- Controls -->
    <div class="filter-form" dir="rtl" style="align-items:center; gap:12px;">
      <mat-form-field appearance="outline">
        <mat-label>קוד חדר הלם</mat-label>
        <mat-select [value]="shockRoomCode" (selectionChange)="onShockRoomCodeChange($event.value)">
          <mat-option value="V">V</mat-option>
          <mat-option value="X">X</mat-option>
        </mat-select>
      </mat-form-field>

      <div class="radio-group" style="display:flex; gap:8px;">
        <span style="align-self:center; margin-inline-end:8px;">תצוגה:</span>
        <button type="button" mat-stroked-button color="primary" [disabled]="surgGrouping==='year'" (click)="setSurgGrouping('year')">שנה</button>
        <button type="button" mat-stroked-button color="primary" [disabled]="surgGrouping==='quarter'" (click)="setSurgGrouping('quarter')">רבעון</button>
        <button type="button" mat-stroked-button color="primary" [disabled]="surgGrouping==='month'" (click)="setSurgGrouping('month')">חודש</button>
      </div>

      <!-- Toggle graph/table -->
      <button type="button" mat-icon-button (click)="toggleSurgGraph()" matTooltip="הצג/הסתר גרף">
        <mat-icon>{{ showSurgGraph ? 'table_chart' : 'bar_chart' }}</mat-icon>
      </button>

      <img src="../../assets/excel.png" alt="Excel"
           (click)="exportAggSurgeryToExcel()" class="download-icon" width="40" />
    </div>

    <!-- ===== GRAPH VIEW (only when toggled on) ===== -->
 <!-- ===== GRAPH VIEW (only when toggled on) ===== -->
<ng-container *ngIf="showSurgGraph">
  <ng-container [ngSwitch]="surgGrouping">

    <!-- Year: percent chart (3 buckets) -->
    <app-trauma-graph
      *ngSwitchCase="'year'"
      [config]="surgBucketPercentChart"
      [height]="360"
      [showValues]="true"
      [percent]="true">
    </app-trauma-graph>

    <!-- Quarter: grouped by quarter (uses surgGraphData built in updateAggSurg) -->
    <app-trauma-graph
    *ngSwitchCase="'quarter'"
    [config]="surgGraphData"
    [height]="360"
    [showValues]="true"
    [percent]="true">     <!-- NEW -->
  </app-trauma-graph>

    <!-- Month: split into 3 charts -->
    <ng-container *ngSwitchCase="'month'">
      <div class="three-grid">
        <app-trauma-graph [config]="surgMonthCharts?.under"   [height]="320" [showValues]="true"></app-trauma-graph>
        <app-trauma-graph [config]="surgMonthCharts?.between" [height]="320" [showValues]="true"></app-trauma-graph>
        <app-trauma-graph [config]="surgMonthCharts?.over"    [height]="320" [showValues]="true"></app-trauma-graph>
      </div>
    </ng-container>

  </ng-container>
</ng-container>


    <!-- ===== TABLE VIEW (only when graph is OFF) ===== -->
    <div class="table-responsive" *ngIf="!showSurgGraph">
      <table mat-table [dataSource]="surgDataSource" matSort #surgSort="matSort" class="mat-elevation-z8 full-width">

        <ng-container matColumnDef="year">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>שנה</th>
          <td mat-cell *matCellDef="let r">{{ r.year }}</td>
        </ng-container>

        <ng-container matColumnDef="quarter">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>רבעון</th>
          <td mat-cell *matCellDef="let r">{{ r.quarter }}</td>
        </ng-container>

        <ng-container matColumnDef="month">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>חודש</th>
          <td mat-cell *matCellDef="let r">{{ r.month }}</td>
        </ng-container>

        <ng-container matColumnDef="under26">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>מתחת ל-26 דק׳</th>
          <td mat-cell *matCellDef="let r">{{ r.under26 }}</td>
        </ng-container>

        <ng-container matColumnDef="between26_60">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>בין 26 ל-60 דק׳</th>
          <td mat-cell *matCellDef="let r">{{ r.between26_60 }}</td>
        </ng-container>

        <ng-container matColumnDef="over60">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>מעל 60 דק׳</th>
          <td mat-cell *matCellDef="let r">{{ r.over60 }}</td>
        </ng-container>

        <ng-container matColumnDef="total">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>סה״כ מקרים</th>
          <td mat-cell *matCellDef="let r">{{ r.total }}</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="surgColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: surgColumns"></tr>
      </table>

      <mat-paginator #surgPaginator
                     [pageSize]="25"
                     [pageSizeOptions]="[10,25,50,100]"
                     showFirstLastButtons>
      </mat-paginator>
    </div>
  </div>
</mat-tab>

    

  </mat-tab-group>
</div>
