<h2 mat-dialog-title dir="rtl">פרטי ניתוח</h2>

<mat-dialog-content dir="rtl" class="content">

  <!-- start form -->
  <form [formGroup]="commentForm" (ngSubmit)="saveComment()" id="commentForm">

    <!-- top summary (readonly display) -->
    <div class="row">
      <div class="label">מספר תיק:</div>
      <div class="value">{{ data.CaseNumber || '—' }}</div>
    </div>
    <div class="row">
      <div class="label">שם מטופל:</div>
      <div class="value">{{ data.PatientName || '—' }}</div>
    </div>
    <div class="row">
      <div class="label">תאריך ניתוח:</div>
      <div class="value">{{ fmtDate(data.SurgeryDate) || '—' }}</div>
    </div>
    <div class="row">
      <div class="label">מחלקה:</div>
      <div class="value">{{ data.Department || '—' }}</div>
    </div>
    <div class="row">
      <div class="label">קוד DRG :</div>
      <div class="value">{{ data.DRG || '—' }}</div>
    </div>
    <div class="row">
      <div class="label">DiagCode:</div>
      <div class="value">{{ data.DiagCode || '—' }}</div>
    </div>
    <div class="row">
      <div class="label">ICD9:</div>
      <div class="value">{{ data.ICD9 || '—' }}</div>
    </div>
    <div class="row">
      <div class="label">שם ניתוח:</div>
      <div class="value">{{ data.SURGERY_NAME || '—' }}</div>
    </div>
    <div class="row">
      <div class="label">דירוג ניתוח:</div>
      <div class="value">{{ data.SurgeryRunk || '—' }}</div>
    </div>

    <mat-divider></mat-divider>

    <!-- doing text -->
    <div class="row">
      <div class="label">סיכום/דוח פעולה:</div>
      <div class="value pre" [innerText]="data.DoingText || '—'"></div>
    </div>

    <mat-divider></mat-divider>
<!-- surgeons -->
<div class="row">
  <div class="label">מנתח 1:</div>
  <div class="value">
    {{ ((data.MainSurgeonNameFirst1 || '') + ' ' + (data.MainSurgeonNameLast1 || '')).trim() || '—' }}
  </div>
</div>

<div class="row">
  <div class="label">אימייל מנתח 1:</div>
  <div class="value">{{ (data.MainSurgeonEmail1 || '').trim() || '—' }}</div>
</div>

<div class="row">
  <div class="label">נייד מנתח 1:</div>
  <div class="value">{{ (data.MainSurgeonCell1 || '').trim() || '—' }}</div>
</div>

<div class="row">
  <div class="label">מנתח 2:</div>
  <div class="value">
    {{ ((data.MainSurgeonNameFirst2 || '') + ' ' + (data.MainSurgeonNameLast2 || '')).trim() || '—' }}
  </div>
</div>

<div class="row">
  <div class="label">אימייל מנתח 2:</div>
  <div class="value">{{ (data.MainSurgeonEmail2 || '').trim() || '—' }}</div>
</div>

<div class="row">
  <div class="label">נייד מנתח 2:</div>
  <div class="value">{{ (data.MainSurgeonCell2 || '').trim() || '—' }}</div>
</div>

    <mat-divider></mat-divider>

    <!-- Hidden controls so values from TS are included in the form payload -->
    <input type="hidden" formControlName="SystemName">
    <input type="hidden" formControlName="CaseNumber">
    <input type="hidden" formControlName="EntryUser">

    <!-- Registrar comments section (bound to form) -->
    <div dir="rtl" style="margin-top:12px;">
      <div style="font-weight:600; margin-bottom:8px;">הערות רשמת</div>

      <mat-form-field appearance="outline" style="width:100%; margin-bottom:8px;">
        <mat-label>המלצת רשמת לחיוב</mat-label>
        <textarea matInput rows="2" formControlName="RegistrarBillingRecommendation"></textarea>
      </mat-form-field>

      <mat-form-field appearance="outline" style="width:100%; margin-bottom:8px;">
        <mat-label>הערות רשמת</mat-label>
        <textarea matInput rows="3" formControlName="RegistrarComments"></textarea>
      </mat-form-field>

      <mat-form-field appearance="outline" style="width:100%; margin-bottom:8px;">
        <mat-label>פניית רשמת לתיקון דוח ניתוח</mat-label>
        <textarea matInput rows="3" formControlName="RegistrarRequestForReportCorrection"></textarea>
      </mat-form-field>
    </div>

    <!-- actions INSIDE the form (submit works) -->
    <mat-dialog-actions align="end" style="margin-top: 12px;">
      <button mat-stroked-button type="button" (click)="close()">סגור</button>

      <button mat-stroked-button type="button" (click)="downloadPdfFromHtml()">
        <mat-icon>picture_as_pdf</mat-icon>&nbsp;PDF
      </button>

      <button
        mat-raised-button
        color="accent"
        type="submit"
        [disabled]="saving || commentForm.invalid">
        <mat-icon>save</mat-icon>&nbsp;שמור הערות
      </button>

      <button mat-raised-button color="primary" type="button" (click)="sendEmail()">
        <mat-icon>email</mat-icon>&nbsp;פתח מייל
      </button>
    </mat-dialog-actions>

  </form>
  <!-- end form -->

</mat-dialog-content>
