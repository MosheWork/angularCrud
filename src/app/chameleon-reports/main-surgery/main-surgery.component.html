<app-welcome-splash
  [durationMs]="5000"
  [closable]="true"
  titleText="מערכת יעל"
  subText="מכין את הדף עבורך…"
  [backgroundImageUrl]="'assets/back1.jpg'"
  (done)="onSplashDone()">
</app-welcome-splash>

<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />

<div class="body">
  <!-- Filters -->
  <form [formGroup]="filterForm" dir="rtl" class="filter-form">
    <div class="container-fluid mb-2">
      <div class="row search-count">
        <div class="col">
          <div dir="rtl" class="card">
            <div dir="rtl" class="card-body">

              <!-- Date range row (surgeryDate) -->
              <div class="filter-row">
                <mat-form-field class="filter-field">
                  <mat-label class="filters">מתאריך ניתוח</mat-label>
                  <input matInput [matDatepicker]="pickerFrom" formControlName="fromDate" dir="rtl" />
                  <mat-datepicker-toggle matSuffix [for]="pickerFrom"></mat-datepicker-toggle>
                  <mat-datepicker #pickerFrom></mat-datepicker>
                </mat-form-field>

                <mat-form-field class="filter-field">
                  <mat-label class="filters">עד תאריך ניתוח</mat-label>
                  <input matInput [matDatepicker]="pickerTo" formControlName="toDate" dir="rtl" />
                  <mat-datepicker-toggle matSuffix [for]="pickerTo"></mat-datepicker-toggle>
                  <mat-datepicker #pickerTo></mat-datepicker>
                </mat-form-field>

                <mat-form-field class="filter-field department-field">
                  <mat-label class="filters">מחלקה</mat-label>
                  <mat-select formControlName="DepartmentFilter" multiple>
                    <mat-option *ngFor="let dep of departmentOptions" [value]="dep">
                      {{ dep }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>

                <div class="spacer"></div>

                <div class="reset-button-container">
                  <button mat-raised-button color="primary" class="custom-button" (click)="resetFilters()" matTooltip="ניקוי מסננים">
                    <i class="material-icons">refresh</i>
                  </button>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Global search + actions -->
    <div dir="rtl" style="display: flex; justify-content: space-between; align-items: center">
      <mat-form-field class="long-search-bar" style="flex: 1; padding-right: 10px">
        <mat-label class="filters" style="color: blue"> חיפוש</mat-label>
        <input matInput [formControlName]="'globalFilter'" class="search-input" />
      </mat-form-field>

      <div class="graph-button-container">
        <img
          (click)="navigateToGraphPage()"
          matTooltip="Move To Graph"
          src="../../../../assets/graphIcon.png"
          width="50px"
        />
      </div>

      <div class="icon" matTooltip="Download Excel">
        <img
          src="../../assets/excel.png"
          alt="Download"
          (click)="exportToExcel()"
          class="download-icon"
          width="50px"
        />
      </div>

      <!-- כפתור תעריפון משרד הבריאות -->
      <button
        mat-raised-button
        color="accent"
        style="margin-right: 10px"
        (click)="openMOHPriceList()"
        matTooltip="פתח קישור תעריפון משרד הבריאות">
        תעריפון משרד הבריאות
      </button>

      <!-- כפתור טבלת שיוך ICD9 -->
      <button
        mat-raised-button
        color="primary"
        style="margin-right: 10px"
        (click)="openICD9Mapping()"
        matTooltip="פתח טבלת שיוך קודי ICD9 וקודי שירות">
        טבלת שיוך ICD9
      </button>
    </div>
  </form>

  <app-sys-graph *ngIf="showGraph" [graphData]="graphData"></app-sys-graph>

  <!-- Table -->
  <mat-table *ngIf="!showGraph"
             [dataSource]="matTableDataSource"
             matSort
             dir="rtl"
             class="mat-elevation-z8">

    <!-- caseNumber -->
    <ng-container matColumnDef="caseNumber">
      <mat-header-cell *matHeaderCellDef mat-sort-header>
        {{ getColumnLabel('caseNumber') }}
      </mat-header-cell>
      <mat-cell *matCellDef="let element">
        {{ element.caseNumber }}
      </mat-cell>
    </ng-container>

    <!-- patientName -->
    <ng-container matColumnDef="patientName">
      <mat-header-cell *matHeaderCellDef mat-sort-header>
        {{ getColumnLabel('patientName') }}
      </mat-header-cell>
      <mat-cell *matCellDef="let element">
        {{ element.patientName }}
      </mat-cell>
    </ng-container>

    <!-- surgeryDate -->
    <ng-container matColumnDef="surgeryDate">
      <mat-header-cell *matHeaderCellDef mat-sort-header>
        {{ getColumnLabel('surgeryDate') }}
      </mat-header-cell>
      <mat-cell *matCellDef="let element">
        {{ element.surgeryDate | date: 'yyyy-MM-dd' }}
      </mat-cell>
    </ng-container>

    <!-- drg -->
    <ng-container matColumnDef="drg">
      <mat-header-cell *matHeaderCellDef mat-sort-header>
        {{ getColumnLabel('drg') }}
      </mat-header-cell>
      <mat-cell *matCellDef="let element">
        {{ element.drg }}
      </mat-cell>
    </ng-container>

    <!-- surgeryName -->
    <ng-container matColumnDef="surgerY_NAME">
      <mat-header-cell *matHeaderCellDef mat-sort-header>
        {{ getColumnLabel('surgerY_NAME') }}
      </mat-header-cell>
      <mat-cell *matCellDef="let element">
        {{ element.surgerY_NAME }}
      </mat-cell>
    </ng-container>

    <!-- department -->
    <ng-container matColumnDef="department">
      <mat-header-cell *matHeaderCellDef mat-sort-header>
        {{ getColumnLabel('department') }}
      </mat-header-cell>
      <mat-cell *matCellDef="let element">
        {{ element.department }}
      </mat-cell>
    </ng-container>

    <!-- icd9 -->
    <ng-container matColumnDef="icd9">
      <mat-header-cell *matHeaderCellDef mat-sort-header>
        {{ getColumnLabel('icd9') }}
      </mat-header-cell>
      <mat-cell *matCellDef="let element">
        {{ element.icd9 }}
      </mat-cell>
    </ng-container>
    <ng-container matColumnDef="keren">
      <mat-header-cell *matHeaderCellDef mat-sort-header>
        {{ getColumnLabel('keren') }}
      </mat-header-cell>
      <mat-cell *matCellDef="let element">
        {{ element.keren }}
      </mat-cell>
    </ng-container>
    <!-- surgeryRunk -->
    <ng-container matColumnDef="surgeryRunk">
      <mat-header-cell *matHeaderCellDef mat-sort-header>
        {{ getColumnLabel('surgeryRunk') }}
      </mat-header-cell>
      <mat-cell *matCellDef="let element">
        {{ element.surgeryRunk }}
      </mat-cell>
    </ng-container>

    <!-- diagCode -->
    <ng-container matColumnDef="diagCode">
      <mat-header-cell *matHeaderCellDef mat-sort-header>
        {{ getColumnLabel('diagCode') }}
      </mat-header-cell>
      <mat-cell *matCellDef="let element">
        {{ element.diagCode }}
      </mat-cell>
    </ng-container>

    <!-- secretaryDRG -->
    <ng-container matColumnDef="secretaryDRG">
      <mat-header-cell *matHeaderCellDef mat-sort-header>
        {{ getColumnLabel('secretaryDRG') }}
      </mat-header-cell>
      <mat-cell *matCellDef="let element">
        {{ element.secretaryDRG }}
      </mat-cell>
    </ng-container>

    <!-- surgeryCodeList -->
    <ng-container matColumnDef="surgeryCodeList">
      <mat-header-cell *matHeaderCellDef mat-sort-header>
        {{ getColumnLabel('surgeryCodeList') }}
      </mat-header-cell>
      <mat-cell *matCellDef="let element">
        {{ element.surgeryCodeList }}
      </mat-cell>
    </ng-container>

    <!-- registrarBillingRecommendation -->
    <ng-container matColumnDef="registrarBillingRecommendation">
      <mat-header-cell *matHeaderCellDef mat-sort-header>
        {{ getColumnLabel('registrarBillingRecommendation') }}
      </mat-header-cell>
      <mat-cell *matCellDef="let element">
        {{ element.registrarBillingRecommendation }}
      </mat-cell>
    </ng-container>

    <!-- registrarComments -->
    <ng-container matColumnDef="registrarComments">
      <mat-header-cell *matHeaderCellDef mat-sort-header>
        {{ getColumnLabel('registrarComments') }}
      </mat-header-cell>
      <mat-cell *matCellDef="let element">
        {{ element.registrarComments }}
      </mat-cell>
    </ng-container>

    <!-- registrarRequestForReportCorrection -->
    <ng-container matColumnDef="registrarRequestForReportCorrection">
      <mat-header-cell *matHeaderCellDef mat-sort-header>
        {{ getColumnLabel('registrarRequestForReportCorrection') }}
      </mat-header-cell>
      <mat-cell *matCellDef="let element">
        {{ element.registrarRequestForReportCorrection }}
      </mat-cell>
    </ng-container>

    <mat-header-row *matHeaderRowDef="columns"></mat-header-row>
    <mat-row
      *matRowDef="let row; columns: columns"
      class="mat-row clickable"
      (click)="openDetails(row)"
      matTooltip="לחץ לשם פרטי הניתוח">
    </mat-row>
  </mat-table>

  <mat-paginator
    [length]="totalResults"
    [pageSize]="filterForm.get('pageSize')?.value || 5"
    [pageSizeOptions]="[10, 50, 100]"
    showFirstLastButtons>
  </mat-paginator>
</div>
