<div class="body" dir="rtl">
    <app-spinner [isLoading]="loading"></app-spinner>
  
    <!-- KPI/Card bar kept simple for total -->
    <!-- <mat-card class="kpi-card" *ngIf="!loading" dir="rtl">
      <mat-card-content>
        <div class="kpi-grid">
          <div class="kpi-item">
            <div class="kpi-title">סה״כ רשומות</div>
            <div class="kpi-value">
              <span class="kpi-strong">{{ totalResults }}</span>
            </div>
            <div class="kpi-foot">לאחר סינון</div>
          </div>
        </div>
      </mat-card-content>
    </mat-card> -->
  
    <!-- Filters (reuse class names so same SCSS applies) -->
    <form [formGroup]="filterForm" class="filter-form" *ngIf="!loading">
      <!-- Period Toggle -->
      <div style="display:flex; gap:12px; align-items:center; margin:8px 0;" dir="rtl">
        <mat-radio-group [formControl]="getFormControl('periodModeCtrl')" aria-label="Period mode">
          <mat-radio-button value="Year">שנה</mat-radio-button>
          <mat-radio-button value="Quarter" style="margin-inline:10px">רבעון</mat-radio-button>
          <mat-radio-button value="Month">חודש</mat-radio-button>
        </mat-radio-group>
  
        <!-- Year -->
        <mat-form-field  style="width:140px;">
          <mat-label>שנה</mat-label>
          <mat-select [formControl]="getFormControl('yearCtrl')">
            <mat-option *ngFor="let y of years" [value]="y">{{ y }}</mat-option>
          </mat-select>
        </mat-form-field>
  
        <!-- Quarter (visible when Quarter mode) -->
        <mat-form-field *ngIf="filterForm.get('periodModeCtrl')?.value === 'Quarter'"  style="width:120px;">
          <mat-label>רבעון</mat-label>
          <mat-select [formControl]="getFormControl('quarterCtrl')">
            <mat-option *ngFor="let q of quarters" [value]="q">Q{{ q }}</mat-option>
          </mat-select>
        </mat-form-field>
  <!-- Quarter filter (multi-select) - always visible -->
<mat-form-field  style="min-width:180px;">
    <mat-label>רבעון (סינון)</mat-label>
    <mat-select [formControl]="getFormControl('quarterFilter')" multiple
    (selectionChange)="applyClientFilters()">
<mat-option [value]="1">Q1</mat-option>
<mat-option [value]="2">Q2</mat-option>
<mat-option [value]="3">Q3</mat-option>
<mat-option [value]="4">Q4</mat-option>
</mat-select>

  </mat-form-field>
  
        <!-- Month (visible when Month mode) -->
        <mat-form-field *ngIf="filterForm.get('periodModeCtrl')?.value === 'Month'"  style="width:160px;">
          <mat-label>חודש</mat-label>
          <mat-select [formControl]="getFormControl('monthCtrl')">
            <mat-option *ngFor="let m of months" [value]="m.val">{{ m.name }}</mat-option>
          </mat-select>
        </mat-form-field>
  
        <!-- Department (auto-populated) -->
        <mat-form-field  style="min-width:220px;">
          <mat-label>{{ getColumnLabel('unitName') }}</mat-label>
          <mat-select [formControl]="getFormControl('unitName')" >
            <mat-option value="">(הכל)</mat-option>
            <mat-option *ngFor="let d of departments" [value]="d">{{ d }}</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
  
      <!-- Top bar: global search + Excel -->
      <div dir="rtl" style="display:flex; justify-content:space-between; align-items:center">
        <mat-form-field class="long-search-bar" style="flex:1; padding-right:10px">
          <mat-label class="filters" style="color: blue">{{ getColumnLabel('globalFilter') }}</mat-label>
          <input matInput [formControlName]="'globalFilter'" class="search-input"/>
        </mat-form-field>
  
        <div class="icon" matTooltip="Download Excel">
          <img src="../../assets/excel.png" alt="Download" (click)="exportToExcel()" class="download-icon" width="50px"/>
        </div>
      </div>
    </form>
  
    <!-- Table -->
    <mat-table *ngIf="!loading" [dataSource]="matTableDataSource" matSort class="mat-elevation-z8">
        <ng-container *ngFor="let c of displayedColumns" [matColumnDef]="c">
            <mat-header-cell *matHeaderCellDef mat-sort-header>
          {{ getColumnLabel(c) }}
        </mat-header-cell>
        <mat-cell *matCellDef="let row">
          <ng-container [ngSwitch]="c">
            <span *ngSwitchDefault>{{ row[c] }}</span>
          </ng-container>
        </mat-cell>
      </ng-container>
  
      <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
      <mat-row *matRowDef="let row; columns: displayedColumns;"></mat-row>
    </mat-table>
  
    <mat-paginator
      [length]="matTableDataSource.data.length"
      [pageSize]="5"
      [pageSizeOptions]="[15,50,100]">
    </mat-paginator>
  </div>
  