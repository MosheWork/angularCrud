<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />

<div class="body" dir="rtl">
  <!--  Profile -->
  <div class="user-info">
    <div class="welcome-text">专  {{ UserName }}</div>
  </div>

<!-- ======================= TOP SUMMARY ROW (FILTERS | GAUGE | GRAPH) ======================= -->
<div class="summary-row" style="display:flex; gap:12px; align-items:stretch; margin:12px 0;">
  <!-- LEFT: Filters (40%) -->
  <div class="card" style="flex:0 0 40%; padding:12px; border-radius:10px; background:#fff; box-shadow:0 2px 10px rgba(0,0,0,.08);">
    <form [formGroup]="filterForm" class="filters-row" style="display:flex; flex-wrap:wrap; gap:12px; align-items:flex-start;">
      <!-- 拽转 转 -->
      <mat-form-field appearance="fill" style="min-width:220px; flex:1 1 220px;">
        <mat-label>拽转 转</mat-label>
        <mat-select formControlName="surgeryDepartmentFilter" (selectionChange)="applyFilters()">
          <mat-option value=""></mat-option>
          <mat-option *ngFor="let d of surgeryDepartmentOptions" [value]="d">{{ d }}</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- 砖 驻专爪专 (multi) -->
      <mat-form-field appearance="fill" style="min-width:260px; flex:1 1 260px;">
        <mat-label>砖 驻专爪专</mat-label>
        <mat-select formControlName="procedureNameFilter" multiple (selectionChange)="applyFilters()">
          <mat-option *ngFor="let p of procedureNameOptions" [value]="p">{{ p }}</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- 砖 (multi) -->
      <mat-form-field appearance="fill" style="min-width:160px; flex:1 1 160px;">
        <mat-label>砖</mat-label>
        <mat-select formControlName="yearFilter" multiple (selectionChange)="applyFilters()">
          <mat-option *ngFor="let y of yearOptions" [value]="y">{{ y }}</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- 砖 (multi) -->
      <mat-form-field appearance="fill" style="min-width:160px; flex:1 1 160px;">
        <mat-label>砖</mat-label>
        <mat-select formControlName="monthFilter" multiple (selectionChange)="applyFilters()">
          <mat-option *ngFor="let m of monthOptions" [value]="m">
            {{ m | number:'2.0-0' }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </form>
  </div>

  <!-- MIDDLE: Gauge (20%) -->
  <div class="card" style="flex:0 0 20%; padding:12px; border-radius:10px; background:#fff; box-shadow:0 2px 10px rgba(0,0,0,.08); display:flex; flex-direction:column; align-items:center; justify-content:center;">
    <ngx-gauge
      [value]="noDrugsPercentage"
      [label]="' 转专驻转 专砖 %'"
      [append]="'%'">
    </ngx-gauge>
    <div class="gauge-summary" style="margin-top:8px; text-align:center;">
      住状: {{ totalRows }}<br />
       转专驻转: {{ noDrugsMatTableDataSource.data.length }}
    </div>
  </div>

  <!-- RIGHT: Monthly chart (40%) -->
  <div class="card" style="flex:0 0 40%; padding:12px; border-radius:10px; background:#fff; box-shadow:0 2px 10px rgba(0,0,0,.08);">
    <div style="display:flex; align-items:center; justify-content:space-between;">
      <h3 style="margin:0;">     转拽 驻专 砖</h3>
    </div>
    <div *ngIf="!monthLabels.length" style="opacity:.7;"> 转 爪</div>

    <!-- Fixed internal resolution, fluid layout -->
    <div style="width:100%; max-width:100%;">
      <div style="position:relative; width:100%; height:auto;">
        <canvas #monthlyCanvas
                width="1100" height="420"
                style="display:block; width:100%; height:auto;"></canvas>
      </div>
    </div>
  </div>
</div>
<!-- ======================= /TOP SUMMARY ROW ======================= -->

  <!--  Global search -->
  <form [formGroup]="filterForm" class="filter-form">
    <div style="display: flex; justify-content: space-between; align-items: center">
      <mat-form-field class="long-search-bar" style="flex: 1; padding-right: 10px">
        <mat-label class="filters" style="color: blue">驻砖</mat-label>
        <input matInput formControlName="globalFilter" class="search-input" (input)="applyFilters()" />
      </mat-form-field>
    </div>
  </form>

  <!-- ===================== TABS ===================== -->
  <mat-tab-group>
    <!-- TAB 1: 状 转专驻转 转 -->
    <mat-tab label="状 转专驻转 转">
      <!-- Controls row -->
      <div style="display:flex; align-items:center; gap:12px; margin:8px 0;">
        <!-- Export (table only) -->
        <img
          *ngIf="!showGraph"
          src="../../assets/excel.png"
          alt="Download"
          (click)="exportToExcelMain()"
          class="download-icon"
          width="50"
          matTooltip="专转 拽住"
        />
  
        <!-- Table/Graph toggle -->
        <button mat-stroked-button (click)="toggleGraph()">
          <mat-icon>{{ showGraph ? 'table_chart' : 'bar_chart' }}</mat-icon>
          {{ showGraph ? '爪 ' : '爪 专祝' }}
        </button>
  
        <!-- Chart type buttons (only when graph is shown) -->
        <button
          *ngIf="showGraph"
          mat-stroked-button
          (click)="setChartType('bar')"
          [disabled]="chartType === 'bar'">
          <mat-icon>bar_chart</mat-icon>
          注转
        </button>
  
        <button
          *ngIf="showGraph"
          mat-stroked-button
          (click)="setChartType('pie')"
          [disabled]="chartType === 'pie'">
          <mat-icon>pie_chart</mat-icon>
          注
        </button>
  
        <!-- Table search (table only) -->
        <mat-form-field appearance="outline" *ngIf="!showGraph" style="margin-inline-start:auto;">
          <mat-label>驻砖 </mat-label>
          <input matInput (keyup)="applyMainFilter($event)" placeholder="驻砖 " />
        </mat-form-field>
      </div>
  
      <!-- Graph view: Chart.js canvas -->
      <div *ngIf="showGraph" style="height:860px; margin-top:12px;">
        <h3 style="margin:0 0 8px;">转驻转 驻 拽爪转  (TimeGroup)</h3>
        <div *ngIf="!timeGroupCounts.length" style="opacity:.7;"> 转 爪</div>
        <canvas #timeGroupCanvas style="width:100%; height:100%;"></canvas>
      </div>
  
      <!-- Table view -->
      <mat-table
        *ngIf="!showGraph"
        [dataSource]="matTableDataSource"
        matSort
        #mainSort="matSort"
        dir="rtl"
        class="mat-elevation-z8"
      >
        <ng-container *ngFor="let column of columns" [matColumnDef]="column">
          <mat-header-cell *matHeaderCellDef mat-sort-header>
            {{ getColumnLabel(column) }}
          </mat-header-cell>
  
          <mat-cell *matCellDef="let row" [ngClass]="getCellClass(column, row[column])">
            <ng-container [ngSwitch]="column">
              <ng-container *ngSwitchCase="'drugGiveTime'">
                {{ row[column] | date: 'yyyy-MM-dd HH:mm' }}
              </ng-container>
              <ng-container *ngSwitchCase="'operationStartTime'">
                {{ row[column] | date: 'yyyy-MM-dd HH:mm' }}
              </ng-container>
              <ng-container *ngSwitchCase="'operationEndTime'">
                {{ row[column] | date: 'yyyy-MM-dd HH:mm' }}
              </ng-container>
              <ng-container *ngSwitchDefault>
                {{ row[column] }}
              </ng-container>
            </ng-container>
          </mat-cell>
        </ng-container>
  
        <mat-header-row *matHeaderRowDef="columns"></mat-header-row>
        <mat-row *matRowDef="let row; columns: columns"></mat-row>
      </mat-table>
  
      <mat-paginator
        *ngIf="!showGraph"
        #mainPaginator
        [length]="matTableDataSource.data.length || 0"
        [pageSize]="5"
        [pageSizeOptions]="[5, 50, 100]">
      </mat-paginator>
    </mat-tab>


    
    <!-- TAB 2:  转专驻转 专砖 -->
    <mat-tab label=" 转专驻转 专砖">
      <div style="display:flex; align-items:center; gap:12px; margin:8px 0;">
        <img
          src="../../assets/excel.png"
          alt="Download"
          (click)="exportToExcelNoDrugs()"
          class="download-icon"
          width="50"
          matTooltip="专转 拽住"
        />
  
        <mat-form-field appearance="outline" style="margin-inline-start:auto;">
          <mat-label>驻砖</mat-label>
          <input matInput (keyup)="applyNoDrugsFilter($event)" placeholder="驻砖 " />
        </mat-form-field>
      </div>
  
      <mat-table
        [dataSource]="noDrugsMatTableDataSource"
        matSort
        #noDrugsSort="matSort"
        dir="rtl"
        class="mat-elevation-z8"
      >
        <ng-container *ngFor="let column of noDrugsColumns" [matColumnDef]="column">
          <mat-header-cell *matHeaderCellDef mat-sort-header>
            {{ getColumnLabel(column) }}
          </mat-header-cell>
          <mat-cell *matCellDef="let row">
            {{ row[column] }}
          </mat-cell>
        </ng-container>
  
        <mat-header-row *matHeaderRowDef="noDrugsColumns"></mat-header-row>
        <mat-row *matRowDef="let row; columns: noDrugsColumns"></mat-row>
      </mat-table>
  
      <mat-paginator
        #noDrugsPaginator
        [length]="noDrugsMatTableDataSource.data.length || 0"
        [pageSize]="5"
        [pageSizeOptions]="[10, 50, 100]">
      </mat-paginator>
    </mat-tab>

<!-- TAB 3: 住驻专 驻 转 转专驻  拽爪转  -->
<!-- TAB 3: 住驻专 驻 转 转专驻  拽爪转  -->
<mat-tab label="驻 转 转专驻 (住驻专 驻 TimeGroup)">
  <div style="display:flex; align-items:center; gap:12px; margin:8px 0;">

    <!-- Export (table only) -->
    <button
      *ngIf="!showMatrixGraph && giveOrderMatrixData?.data?.length"
      mat-stroked-button
      (click)="exportGiveOrderMatrix()">
      <mat-icon>download</mat-icon>
      爪 拽住
    </button>

    <!-- Table/Graph toggle -->
    <button mat-stroked-button (click)="toggleMatrixGraph()">
      <mat-icon>{{ showMatrixGraph ? 'table_chart' : 'bar_chart' }}</mat-icon>
      {{ showMatrixGraph ? '爪 ' : '爪 专祝 (Valid%)' }}
    </button>

    <mat-form-field appearance="outline" style="margin-inline-start:auto;">
      <mat-label>驻砖</mat-label>
      <input
        matInput
        (keyup)="applyGiveOrderMatrixFilter($event)"
        placeholder="驻砖 驻 砖转 " />
    </mat-form-field>
  </div>

  <!-- Graph view (Valid% by GiveOrderName) -->
  <div *ngIf="showMatrixGraph" style="height:860px; margin-top:12px;">
    <h3 style="margin:0 0 8px;">Valid% 驻 转 转专驻</h3>
    <div *ngIf="!giveOrderMatrixData?.data?.length" style="opacity:.7;"> 转 爪</div>
    <canvas #matrixCanvas style="width:100%; height:100%;"></canvas>
  </div>

  <!-- Table view -->
  <mat-table
    *ngIf="!showMatrixGraph"
    [dataSource]="giveOrderMatrixData"
    matSort
    #matrixSort="matSort"
    dir="rtl"
    class="mat-elevation-z8">

    <ng-container *ngFor="let col of giveOrderMatrixColumns" [matColumnDef]="col">
      <mat-header-cell *matHeaderCellDef mat-sort-header>
        <ng-container [ngSwitch]="col">
          <ng-container *ngSwitchCase="'giveOrderName'">转 转专驻</ng-container>
          <ng-container *ngSwitchCase="'total'">住状</ng-container>
          <ng-container *ngSwitchCase="'validPercent'">Valid%</ng-container>
          <ng-container *ngSwitchDefault>{{ col }}</ng-container>
        </ng-container>
      </mat-header-cell>

      <mat-cell *matCellDef="let row">
        <ng-container [ngSwitch]="col">
          <ng-container *ngSwitchCase="'validPercent'">
            {{ row[col] | number:'1.0-1' }}%
          </ng-container>
          <ng-container *ngSwitchDefault>
            {{ row[col] }}
          </ng-container>
        </ng-container>
      </mat-cell>
    </ng-container>

    <mat-header-row *matHeaderRowDef="giveOrderMatrixColumns"></mat-header-row>
    <mat-row *matRowDef="let row; columns: giveOrderMatrixColumns"></mat-row>
  </mat-table>

  <mat-paginator
    *ngIf="!showMatrixGraph"
    #matrixPaginator
    [length]="giveOrderMatrixData.data.length || 0"
    [pageSize]="5"
    [pageSizeOptions]="[10, 25, 50, 100]">
  </mat-paginator>
</mat-tab>



  </mat-tab-group>
  
</div>
