<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />

<div class="body">
  <!-- 👤 Profile Section -->
  <div class="user-info">
    <!-- <img [src]="profilePictureUrl" alt="User Profile" class="profile-pic" /> -->
    <div class="welcome-text">ברוך הבא {{ UserName }}</div>
  </div>
  <form [formGroup]="filterForm" dir="rtl"
  class="filters-row"
  style="display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin: 8px 0 16px;">
<!-- TopProcedure (<= threshold) -->
<mat-form-field appearance="fill" style="min-width:180px;">
<mat-label>TopProcedure</mat-label>
<mat-select formControlName="topProcedure" (selectionChange)="applyFilters()">
  <mat-option [value]="null">הכול</mat-option>
  <mat-option *ngFor="let n of topProcedureOptions" [value]="n">{{ n }}</mat-option>
</mat-select>
</mat-form-field>

<!-- Surgery Department -->
<mat-form-field appearance="fill" style="min-width:220px;">
<mat-label>מחלקת ניתוח</mat-label>
<mat-select formControlName="surgeryDepartmentFilter" (selectionChange)="applyFilters()">
  <mat-option value="">הכול</mat-option>
  <mat-option *ngFor="let d of surgeryDepartmentOptions" [value]="d">{{ d }}</mat-option>
</mat-select>
</mat-form-field>

<!-- GiveOrderName -->
<mat-form-field appearance="fill" style="min-width:220px;">
<mat-label>נותן התרופה</mat-label>
<mat-select formControlName="giveOrderNameFilter" (selectionChange)="applyFilters()">
  <mat-option value="">הכול</mat-option>
  <mat-option *ngFor="let g of giveOrderNameOptions" [value]="g">{{ g }}</mat-option>
</mat-select>
</mat-form-field>

<!-- TimeGroup -->
<mat-form-field appearance="fill" style="min-width:200px;">
<mat-label>קבוצת זמן</mat-label>
<mat-select formControlName="timeGroup" (selectionChange)="applyFilters()">
  <mat-option value="">הכול</mat-option>
  <mat-option *ngFor="let tg of timeGroupOptions" [value]="tg">{{ tg }}</mat-option>
</mat-select>
</mat-form-field>
</form>

  
  <div class="summary-card-wrapper" dir="rtl">
    <div class="gauge-wrapper">
      <ngx-gauge
        [value]="noDrugsPercentage"
        [label]="'ללא תרופות ברשימה %'"
        [append]="'%'">
      </ngx-gauge>

      <div class="gauge-summary">
        סה״כ: {{ totalRows }} | ללא תרופות: {{ noDrugsMatTableDataSource.data.length }}
      </div>
    </div>

    <mat-card class="summary-card">
      <div
        class="summary-box mat-accent"
        (click)="applyColorFilter('green')"
        [ngClass]="{ active: selectedColor === 'green' }">
        30-60<br />{{ summary.green }}
      </div>

      <div
        class="summary-box custom-orange"
        (click)="applyColorFilter('orange')"
        [ngClass]="{ active: selectedColor === 'orange' }">
        0-30<br />{{ summary.orange }}
      </div>

      <div
        class="summary-box mat-warn"
        (click)="applyColorFilter('red')"
        [ngClass]="{ active: selectedColor === 'red' }">
        60+<br />{{ summary.red }}
      </div>

      <div
        class="summary-box custom-grey"
        (click)="applyNegativeOrEmptyFilter()"
        [ngClass]="{ active: selectedColor === 'negativeOrEmpty' }">
        ריק<br />{{ summary.negativeOrEmpty }}
      </div>

      <div class="summary-box total">
        סה"כ<br />{{ summary.total }}
      </div>

      <button mat-stroked-button class="blue-button" (click)="clearColorFilter()">נקה סינון</button>
    </mat-card>

    <button
      *ngIf="canManageICD9()"
      mat-raised-button
      color="primary"
      (click)="openProcedureDialog()"
      style="margin: 10px;">
      ניהול קודי ICD9
    </button>
  </div>

  <form [formGroup]="filterForm" dir="rtl" class="filter-form">
    <div dir="rtl" style="display: flex; justify-content: space-between; align-items: center">
      <mat-form-field class="long-search-bar" style="flex: 1; padding-right: 10px">
        <mat-label class="filters" style="color: blue"> חיפוש</mat-label>
        <input matInput [formControlName]="'globalFilter'" class="search-input" />
      </mat-form-field>
    </div>
  </form>

  <mat-tab-group dir="rtl">
    <!-- ✅ TAB 1: Drug Surgery Report -->
    <mat-tab label="דו״ח תרופות וניתוחים">
      <img
        src="../../assets/excel.png"
        alt="Download"
        (click)="exportToExcelMain()"
        class="download-icon"
        width="50px" />

      <mat-form-field appearance="outline">
        <mat-label>חיפוש</mat-label>
        <input matInput (keyup)="applyMainFilter($event)" placeholder="חפש בטבלה" />
      </mat-form-field>

      <mat-table
        [dataSource]="matTableDataSource"
        matSort
        #mainSort="matSort"
        dir="rtl"
        class="mat-elevation-z8">

        <ng-container *ngFor="let column of columns" [matColumnDef]="column">
          <mat-header-cell *matHeaderCellDef mat-sort-header>
            {{ getColumnLabel(column) }}
          </mat-header-cell>

          <mat-cell *matCellDef="let row" [ngClass]="getCellClass(column, row[column])">
            <ng-container [ngSwitch]="column">
              <ng-container *ngSwitchCase="'drugGiveTime'">
                {{ row[column] | date:'yyyy-MM-dd HH:mm' }}
              </ng-container>
              <ng-container *ngSwitchCase="'operationStartTime'">
                {{ row[column] | date:'yyyy-MM-dd HH:mm' }}
              </ng-container>
              <ng-container *ngSwitchCase="'operationEndTime'">
                {{ row[column] | date:'yyyy-MM-dd HH:mm' }}
              </ng-container>
              <ng-container *ngSwitchDefault>
                {{ row[column] }}
              </ng-container>
            </ng-container>
          </mat-cell>
        </ng-container>

        <mat-header-row *matHeaderRowDef="columns"></mat-header-row>
        <mat-row *matRowDef="let row; columns: columns"></mat-row>
      </mat-table>

      <mat-paginator
        #mainPaginator
        [length]="matTableDataSource.data.length || 0"
        [pageSize]="5"
        [pageSizeOptions]="[5, 50, 100]">
      </mat-paginator>
    </mat-tab>

    <!-- ✅ TAB 2: No Drugs Report -->
    <mat-tab label="ללא תרופות ברשימה">
      <img
        src="../../assets/excel.png"
        alt="Download"
        (click)="exportToExcelNoDrugs()"
        class="download-icon"
        width="50px" />

      <mat-form-field appearance="outline">
        <mat-label>חיפוש</mat-label>
        <input matInput (keyup)="applyNoDrugsFilter($event)" placeholder="חפש בטבלה" />
      </mat-form-field>

      <mat-table
        [dataSource]="noDrugsMatTableDataSource"
        matSort
        #noDrugsSort="matSort"
        dir="rtl"
        class="mat-elevation-z8">

        <ng-container *ngFor="let column of noDrugsColumns" [matColumnDef]="column">
          <mat-header-cell *matHeaderCellDef mat-sort-header>
            {{ getColumnLabel(column) }}
          </mat-header-cell>
          <mat-cell *matCellDef="let row">
            {{ row[column] }}
          </mat-cell>
        </ng-container>

        <mat-header-row *matHeaderRowDef="noDrugsColumns"></mat-header-row>
        <mat-row *matRowDef="let row; columns: noDrugsColumns"></mat-row>
      </mat-table>

      <mat-paginator
        #noDrugsPaginator
        [length]="noDrugsMatTableDataSource.data.length || 0"
        [pageSize]="5"
        [pageSizeOptions]="[10, 50, 100]">
      </mat-paginator>
    </mat-tab>
  </mat-tab-group>
</div>
