<app-spinner [isLoading]="isLoading"></app-spinner>

<div class="measurement-wrapper" *ngIf="!isLoading">

  <!-- ===== Filters ===== -->
  <mat-card class="filter-card" style="margin-bottom: 16px;">
    <div class="filter-row" dir="rtl">
      <mat-form-field>
        <mat-label>×©× ×”</mat-label>
        <mat-select [(ngModel)]="selectedYears" multiple>
          <mat-option *ngFor="let year of years" [value]="year">{{ year }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field>
        <mat-label>×¨×‘×¢×•×Ÿ</mat-label>
        <mat-select [(ngModel)]="selectedQuarters" multiple>
          <mat-option *ngFor="let quarter of quarters" [value]="quarter">{{ quarter }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field>
        <mat-label>×—×•×“×©</mat-label>
        <mat-select [(ngModel)]="selectedMonths" multiple>
          <mat-option *ngFor="let month of months" [value]="month">{{ month }}</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- ××—×œ×§×” -->
      <mat-form-field>
        <mat-label>××—×œ×§×”</mat-label>
        <mat-select [(ngModel)]="selectedDepartments" multiple>
          <mat-option *ngFor="let dept of departments" [value]="dept">{{ dept }}</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- ××“×“ -->
      <mat-form-field class="wide-select">
        <mat-label>××“×“</mat-label>
      
        <mat-select [(ngModel)]="selectedMeasurements" multiple (openedChange)="opened = $event">
          <!-- Search box pinned at top of panel -->
          <mat-option disabled (click)="$event.stopPropagation()">
            <mat-form-field appearance="outline" style="width:100%; margin-top:4px;">
              <input
                matInput
                #searchBox
                placeholder="×—×™×¤×•×©â€¦"
                [value]="measurementSearch"
                (keydown)="$event.stopPropagation()"
                (input)="onMeasurementSearch(searchBox.value)" />
            </mat-form-field>
          </mat-option>
      
          <!-- Filtered options -->
          <mat-option *ngFor="let m of measurementsFiltered" [value]="m">
            {{ m }}
          </mat-option>
        </mat-select>
      </mat-form-field>
      
      
      

      <button mat-raised-button color="primary" (click)="applyFilter()">×¡× ×Ÿ</button>
      <button mat-raised-button color="warn" (click)="resetFilter()">××™×¤×•×¡</button>
    </div>

    <!-- ===== Summary Card =====
    <mat-card-title>ğŸ§¾ ×¡×™×›×•× ×—×™×©×•×‘</mat-card-title>
    <mat-card-content>
      <div *ngIf="summaryInfo?.measurementSelected; else allMeasurementsBlock">
        <p>××“×“ × ×‘×—×¨: <strong>{{ summaryInfo?.measurementCode }}</strong></p>

        <p *ngIf="selectedYears.length">×©× ×™×:
          <strong>{{ selectedYears.join(', ') }}</strong>
        </p>

        <p *ngIf="selectedQuarters.length">×¨×‘×¢×•× ×™×:
          <strong>{{ selectedQuarters.join(', ') }}</strong>
        </p>

        <p *ngIf="selectedMonths.length">×—×•×“×©×™×:
          <strong>{{ selectedMonths.join(', ') }}</strong>
        </p>

        <p>×¦×™×•×Ÿ: <strong>{{ summaryInfo?.grade }}%</strong></p>
        <p>×™×¢×“: <strong>{{ summaryInfo?.target }}%</strong></p>
      </div>

      <ng-template #allMeasurementsBlock>
        <p *ngIf="yearGaugeValue! > 0">
          ××•× ×” / ××›× ×” (×©× ×”): <strong>{{ summaryInfo?.totalMone }} / {{ summaryInfo?.totalMechane }}</strong><br>
          ×¦×™×•×Ÿ ×›×•×œ×œ (×©× ×”): <strong>{{ yearGaugeValue! }}%</strong>
        </p>

        <p *ngIf="quarterGaugeValue! > 0">
          ××•× ×” / ××›× ×” (×¨×‘×¢×•×Ÿ): <strong>{{ quarterMone }} / {{ quarterMechane }}</strong><br>
          ×¦×™×•×Ÿ ×›×•×œ×œ (×¨×‘×¢×•×Ÿ): <strong>{{ quarterGaugeValue! }}%</strong>
        </p>

        <p *ngIf="monthGaugeValue! > 0">
          ××•× ×” / ××›× ×” (×—×•×“×©): <strong>{{ monthMone }} / {{ monthMechane }}</strong><br>
          ×¦×™×•×Ÿ ×›×•×œ×œ (×—×•×“×©): <strong>{{ monthGaugeValue! }}%</strong>
        </p>
      </ng-template>
    </mat-card-content> -->
  </mat-card>

  <!-- ===== Gauges ===== -->
<div class="gauge-section" dir="rtl" style="display: flex; gap: 24px; flex-wrap: wrap;">
  <!-- Year Gauge -->
  <mat-card class="gauge-card">
    <div class="gauge-title">×©× ×”</div>
    <ngx-gauge
      [value]="yearGaugeValue ?? 0"
      [min]="0"
      [max]="100"
      [label]="''"
      [append]="'%'"
      [type]="'semi'"
      [thick]="6"
      [size]="180"
      [foregroundColor]="getGaugeColor(yearGaugeValue)"
      [valueText]="yearGaugeValue !== null ? (yearGaugeValue | number:'1.0-0') + '%' : '××™×Ÿ × ×ª×•× ×™×'">
    </ngx-gauge>

    <div class="gauge-details">
      ××•× ×” / ××›× ×”: {{ yearMone }} / {{ yearMechane }}<br>
    </div>

    <div *ngIf="showYearDetails">
      <table mat-table [dataSource]="yearlySummaryRaw" class="mat-elevation-z1" style="margin-top: 8px; width: 100%;">
        <ng-container matColumnDef="MeasurementCode">
          <th mat-header-cell *matHeaderCellDef> ×§×•×“ ××“×“ </th>
          <td mat-cell *matCellDef="let row"> {{ row.MeasurementCode }} </td>
        </ng-container>

        <ng-container matColumnDef="MeasurementShortDesc">
          <th mat-header-cell *matHeaderCellDef> ××“×“ </th>
          <td mat-cell *matCellDef="let row"> {{ row.MeasurementShortDesc }} </td>
        </ng-container>

        <ng-container matColumnDef="Grade">
          <th mat-header-cell *matHeaderCellDef> ×¦×™×•×Ÿ </th>
          <td mat-cell *matCellDef="let row"> {{ row.Grade }}% </td>
        </ng-container>

        <ng-container matColumnDef="MTarget">
          <th mat-header-cell *matHeaderCellDef> ×™×¢×“ </th>
          <td mat-cell *matCellDef="let row"> {{ row.MTarget }}% </td>
        </ng-container>

        <ng-container matColumnDef="MeetsTarget">
          <th mat-header-cell *matHeaderCellDef> ×¢××“ ×‘×™×¢×“ </th>
          <td mat-cell *matCellDef="let row"> {{ row.MeetsTarget }} </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="gaugeColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: gaugeColumns;"></tr>
      </table>
    </div>
  </mat-card>

  <!-- Quarter Gauge -->
  <mat-card class="gauge-card">
    <div class="gauge-title">×¨×‘×¢×•×Ÿ</div>
    <ngx-gauge
      [value]="quarterGaugeValue ?? 0"
      [min]="0"
      [max]="100"
      [label]="''"
      [append]="'%'"
      [type]="'semi'"
      [thick]="6"
      [size]="180"
      [foregroundColor]="getGaugeColor(quarterGaugeValue)"
      [valueText]="quarterGaugeValue !== null ? (quarterGaugeValue | number:'1.0-0') + '%' : '××™×Ÿ × ×ª×•× ×™×'">
    </ngx-gauge>

    <div class="gauge-details">
      ××•× ×” / ××›× ×”: {{ quarterMone }} / {{ quarterMechane }}<br>
    </div>

    <div *ngIf="showQuarterDetails">
      <table mat-table [dataSource]="quarterlySummaryRaw" class="mat-elevation-z1" style="margin-top: 8px; width: 100%;">
        <ng-container matColumnDef="MeasurementCode">
          <th mat-header-cell *matHeaderCellDef> ×§×•×“ ××“×“ </th>
          <td mat-cell *matCellDef="let row"> {{ row.MeasurementCode }} </td>
        </ng-container>

        <ng-container matColumnDef="MeasurementShortDesc">
          <th mat-header-cell *matHeaderCellDef> ××“×“ </th>
          <td mat-cell *matCellDef="let row"> {{ row.MeasurementShortDesc }} </td>
        </ng-container>

        <ng-container matColumnDef="Grade">
          <th mat-header-cell *matHeaderCellDef> ×¦×™×•×Ÿ </th>
          <td mat-cell *matCellDef="let row"> {{ row.Grade }}% </td>
        </ng-container>

        <ng-container matColumnDef="MTarget">
          <th mat-header-cell *matHeaderCellDef> ×™×¢×“ </th>
          <td mat-cell *matCellDef="let row"> {{ row.MTarget }}% </td>
        </ng-container>

        <ng-container matColumnDef="MeetsTarget">
          <th mat-header-cell *matHeaderCellDef> ×¢××“ ×‘×™×¢×“ </th>
          <td mat-cell *matCellDef="let row"> {{ row.MeetsTarget }} </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="gaugeColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: gaugeColumns;"></tr>
      </table>
    </div>
  </mat-card>

  <!-- Month Gauge -->
  <mat-card class="gauge-card">
    <div class="gauge-title">×—×•×“×©</div>
    <ngx-gauge
      [value]="monthGaugeValue ?? 0"
      [min]="0"
      [max]="100"
      [label]="''"
      [append]="'%'"
      [type]="'semi'"
      [thick]="6"
      [size]="180"
      [foregroundColor]="getGaugeColor(monthGaugeValue)"
      [valueText]="monthGaugeValue !== null ? (monthGaugeValue | number:'1.0-0') + '%' : '××™×Ÿ × ×ª×•× ×™×'">
    </ngx-gauge>

    <div class="gauge-details">
      ××•× ×” / ××›× ×”: {{ monthMone }} / {{ monthMechane }}<br>
    </div>

    <div *ngIf="showMonthDetails">
      <table mat-table [dataSource]="monthlySummaryRaw" class="mat-elevation-z1" style="margin-top: 8px; width: 100%;">
        <ng-container matColumnDef="MeasurementCode">
          <th mat-header-cell *matHeaderCellDef> ×§×•×“ ××“×“ </th>
          <td mat-cell *matCellDef="let row"> {{ row.MeasurementCode }} </td>
        </ng-container>

        <ng-container matColumnDef="MeasurementShortDesc">
          <th mat-header-cell *matHeaderCellDef> ××“×“ </th>
          <td mat-cell *matCellDef="let row"> {{ row.MeasurementShortDesc }} </td>
        </ng-container>

        <ng-container matColumnDef="Grade">
          <th mat-header-cell *matHeaderCellDef> ×¦×™×•×Ÿ </th>
          <td mat-cell *matCellDef="let row"> {{ row.Grade }}% </td>
        </ng-container>

        <ng-container matColumnDef="MTarget">
          <th mat-header-cell *matHeaderCellDef> ×™×¢×“ </th>
          <td mat-cell *matCellDef="let row"> {{ row.MTarget }}% </td>
        </ng-container>

        <ng-container matColumnDef="MeetsTarget">
          <th mat-header-cell *matHeaderCellDef> ×¢××“ ×‘×™×¢×“ </th>
          <td mat-cell *matCellDef="let row"> {{ row.MeetsTarget }} </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="gaugeColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: gaugeColumns;"></tr>
      </table>
    </div>
  </mat-card>
</div>


  <!-- ===== Tabs ===== -->
  <mat-tab-group dir="rtl">

    <!-- === By Measurement === -->
    <mat-tab label="×¡×™×›×•× ×œ×¤×™ ××“×“">
      <img src="../../assets/excel.png" alt="Download" (click)="exportMeasurementSummary()" class="download-icon icon" width="50px" style="margin-left: 10px;" />
      <mat-form-field appearance="outline">
        <mat-label>×—×™×¤×•×© ×›×œ×œ×™</mat-label>
        <input matInput type="text" (input)="onMeasurementFilter($event)" placeholder="×¡× ×Ÿ ×‘×˜×‘×œ×”..." />
      </mat-form-field>

      <table mat-table [dataSource]="measurementDataSource" matSort #measurementSort="matSort" class="mat-elevation-z8" dir="rtl">

        <ng-container matColumnDef="measurementCode">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>×§×•×“ ××“×“</th>
          <td mat-cell *matCellDef="let row">{{ row.measurementCode }}</td>
        </ng-container>

        <ng-container matColumnDef="measurementShortDesc">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>×ª×™××•×¨</th>
          <td mat-cell *matCellDef="let row">{{ row.measurementShortDesc }}</td>
        </ng-container>

        <ng-container matColumnDef="mone">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>××•× ×”</th>
          <td mat-cell *matCellDef="let row">{{ row.mone }}</td>
        </ng-container>

        <ng-container matColumnDef="mechane">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>××›× ×”</th>
          <td mat-cell *matCellDef="let row">{{ row.mechane }}</td>
        </ng-container>
     <!-- By Measurement table -->
<ng-container matColumnDef="avgTotalTimeInUnit">
  <th mat-header-cell *matHeaderCellDef> ×–××Ÿ ×××•×¦×¢ ×‘×™×—×™×“×” (×“×§×³) </th>
  <td mat-cell *matCellDef="let row">
    {{ row.avgTotalTimeInUnit != null ? (row.avgTotalTimeInUnit | number:'1.1-1') : '' }}
  </td>
</ng-container>

        <ng-container matColumnDef="grade">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>××—×•×–</th>
          <td mat-cell *matCellDef="let row">
            <span [ngClass]="getCellClass(row.grade, row.measurementCode)">
              {{ row.grade !== null && row.grade !== undefined ? (row.grade | number:'1.0-0') + '%' : '-' }}
            </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="target">
          <th mat-header-cell *matHeaderCellDef>×™×¢×“</th>
          <td mat-cell *matCellDef="let row">
            {{ getTargetValue(row.measurementCode) ?? '-' }}%
          </td>
        </ng-container>

        <ng-container matColumnDef="allUnitsGrade">
          <th mat-header-cell *matHeaderCellDef>×›×œ×œ ×”×™×—×™×“×•×ª</th>
          <td mat-cell *matCellDef="let row">
            <span [ngClass]="getCellClass(allUnitsGradeMap[row.measurementCode], row.measurementCode)">
              {{ allUnitsGradeMap[row.measurementCode] !== null && allUnitsGradeMap[row.measurementCode] !== undefined ? (allUnitsGradeMap[row.measurementCode] | number:'1.1-1') + '%' : '-' }}
            </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="pdf">
          <th mat-header-cell *matHeaderCellDef>×¤×™×¨×•×˜ ×”××“×“</th>
          <td mat-cell *matCellDef="let row">
            <img src="assets/pdf.png"
                 alt="×¦×¤×” ×‘×§×•×‘×¥ PDF"
                 matTooltip="×¦×¤×” ×‘×§×•×‘×¥ PDF"
                 style="cursor: pointer; width: 30px;"
                 (click)="viewPDF(row.measurementCode)" />
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedMeasurementColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedMeasurementColumns;"></tr>
      </table>

      <mat-paginator
        #measurementPaginator
        [pageSizeOptions]="[10, 20, 50]"
        showFirstLastButtons>
      </mat-paginator>
    </mat-tab>

    <!-- === By Department === -->
    <mat-tab label="×¡×™×›×•× ×œ×¤×™ ××—×œ×§×”">
      <div class="filter-export-row" style="display: flex; align-items: center; gap: 16px; margin: 10px 0;">
        <img src="../../assets/excel.png" alt="Download" (click)="exportDepartmentSummary()" width="50px" />
        <mat-form-field appearance="outline">
          <mat-label>×—×™×¤×•×© ×›×œ×œ×™</mat-label>
          <input matInput type="text" (input)="applyGlobalFilter($event, 'department')" placeholder="×¡× ×Ÿ ×‘×˜×‘×œ×”..." />
        </mat-form-field>
      </div>

      <table mat-table [dataSource]="departmentDataSource" matSort #departmentSort="matSort" class="mat-elevation-z8" dir="rtl">

        <ng-container matColumnDef="measurementCode">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>×§×•×“ ××“×“</th>
          <td mat-cell *matCellDef="let row">{{ row.measurementCode }}</td>
        </ng-container>

        <ng-container matColumnDef="measurementShortDesc">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>×©× ××“×“</th>
          <td mat-cell *matCellDef="let row">{{ row.measurementShortDesc }}</td>
        </ng-container>

        <ng-container matColumnDef="department">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>××—×œ×§×”</th>
          <td mat-cell *matCellDef="let row">{{ row.department || '××™×Ÿ × ×ª×•× ×™×' }}</td>
        </ng-container>

        <ng-container matColumnDef="mone">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>××•× ×”</th>
          <td mat-cell *matCellDef="let row">{{ row.mone }}</td>
        </ng-container>

        <ng-container matColumnDef="mechane">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>××›× ×”</th>
          <td mat-cell *matCellDef="let row">{{ row.mechane }}</td>
        </ng-container>

        <ng-container matColumnDef="grade">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>××—×•×–</th>
          <td mat-cell *matCellDef="let row">{{ row.grade | number:'1.0-0' }}%</td>
        </ng-container>

        <ng-container matColumnDef="allUnitsGrade">
          <th mat-header-cell *matHeaderCellDef>×›×œ×œ ×”×™×—×™×“×•×ª</th>
          <td mat-cell *matCellDef="let row">
            <span [ngClass]="getCellClass(allUnitsGradeMap[row.measurementCode], row.measurementCode)">
              {{ allUnitsGradeMap[row.measurementCode] !== null && allUnitsGradeMap[row.measurementCode] !== undefined ? (allUnitsGradeMap[row.measurementCode] | number:'1.0-0') + '%' : '-' }}
            </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="target">
          <th mat-header-cell *matHeaderCellDef>×™×¢×“</th>
          <td mat-cell *matCellDef="let row">
            {{ getTargetValue(row.measurementCode) ?? '-' }}%
          </td>
        </ng-container>
       <!-- By Department table -->
<ng-container matColumnDef="avgTotalTimeInUnit">
  <th mat-header-cell *matHeaderCellDef> ×–××Ÿ ×××•×¦×¢ ×‘×™×—×™×“×” (×“×§×³) </th>
  <td mat-cell *matCellDef="let row">
    {{ row.avgTotalTimeInUnit != null ? (row.avgTotalTimeInUnit | number:'1.1-1') : '' }}
  </td>
</ng-container>
        <tr mat-header-row *matHeaderRowDef="displayedDepartmentColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedDepartmentColumns;"></tr>
      </table>

      <mat-paginator
        #departmentPaginator
        [pageSizeOptions]="[10, 20, 50]"
        showFirstLastButtons>
      </mat-paginator>
    </mat-tab>

    <!-- === Periodic Summary === -->
    <mat-tab label="×¡×™×›×•× ×ª×§×•×¤×ª×™ ">
      <mat-card class="filter-card" style="margin-bottom: 16px;" dir="rtl">
        <mat-form-field appearance="outline" style="margin-bottom: 16px; width: 300px;">
          <mat-label>×¡×™× ×•×Ÿ ×’×œ×•×‘×œ×™</mat-label>
          <input matInput (input)="applyGlobalPivotFilter($event)" placeholder="×”×§×œ×“ ×˜×§×¡×˜ ×œ×—×™×¤×•×©">
        </mat-form-field>
        <mat-radio-group [(ngModel)]="selectedPivot" (change)="assignTableConfig()">
          <mat-radio-button value="yearly">×©× ×ª×™</mat-radio-button>
          <mat-radio-button value="quarterly">×¨×‘×¢×•× ×™</mat-radio-button>
          <mat-radio-button value="monthly">×—×•×“×©×™</mat-radio-button>
        </mat-radio-group>

        <img
          src="../../assets/excel.png"
          alt="Download"
          (click)="exportSelectedPivot()"
          class="download-icon icon"
          width="50px"
          style="margin-right: 16px;" />
      </mat-card>

      <!-- Yearly Table -->
      <div [hidden]="selectedPivot !== 'yearly'">
        <mat-card class="yearly-table-card" dir="rtl">
          <mat-card-title>×“×•×— ×©× ×ª×™ ×œ×¤×™ ××“×“</mat-card-title>
          <div class="mat-elevation-z4">
            <table mat-table [dataSource]="yearlyDataSource" class="mat-table" matSort #yearlySort="matSort">
              <ng-container *ngFor="let col of yearlyDisplayedColumns" [matColumnDef]="col">
                <th mat-header-cell *matHeaderCellDef>
                  {{ col === '×§×•×“ ××“×“' ? '×§×•×“ ××“×“' : col === '×©× ××“×“' ? '×©× ××“×“' : col }}
                </th>
                <td mat-cell *matCellDef="let element">
                  <ng-container *ngIf="col === '×§×•×“ ××“×“' || col === '×©× ××“×“'; else percentageCellY">
                    {{ element[col] }}
                  </ng-container>
                  <ng-template #percentageCellY>
                    <span [ngClass]="getCellClass(element[col], element['×§×•×“ ××“×“'])">
                      {{ element[col] !== null && element[col] !== undefined ? (element[col] | number:'1.0-0') + '%' : '' }}
                    </span>
                  </ng-template>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="yearlyDisplayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: yearlyDisplayedColumns;"></tr>
            </table>

            <mat-paginator #yearlyPaginator [pageSizeOptions]="[10, 20, 50]" showFirstLastButtons></mat-paginator>
          </div>
        </mat-card>
      </div>

      <!-- Quarterly Table -->
      <div [hidden]="selectedPivot !== 'quarterly'">
        <mat-card class="quarterly-table-card" dir="rtl">
          <mat-card-title>×“×•×— ×¨×‘×¢×•× ×™ ×œ×¤×™ ××“×“</mat-card-title>
          <div class="mat-elevation-z4">
            <table mat-table [dataSource]="quarterlyDataSource" class="mat-table" matSort #quarterlySort="matSort">
              <ng-container *ngFor="let col of quarterlyDisplayedColumns" [matColumnDef]="col">
                <th mat-header-cell *matHeaderCellDef>
                  {{ col === '×§×•×“ ××“×“' ? '×§×•×“ ××“×“' : col === '×©× ××“×“' ? '×©× ××“×“' : col }}
                </th>
                <td mat-cell *matCellDef="let element">
                  <ng-container *ngIf="col === '×§×•×“ ××“×“' || col === '×©× ××“×“'; else percentageCellQ">
                    {{ element[col] }}
                  </ng-container>
                  <ng-template #percentageCellQ>
                    <span [ngClass]="getCellClass(element[col], element['×§×•×“ ××“×“'])">
                      {{ element[col] !== null && element[col] !== undefined ? (element[col] | number:'1.0-0') + '%' : '' }}
                    </span>
                  </ng-template>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="quarterlyDisplayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: quarterlyDisplayedColumns;"></tr>
            </table>

            <mat-paginator #quarterlyPaginator [pageSizeOptions]="[10, 20, 50]" showFirstLastButtons></mat-paginator>
          </div>
        </mat-card>
      </div>

      <!-- Monthly Table -->
      <div [hidden]="selectedPivot !== 'monthly'">
        <mat-card class="monthly-table-card" dir="rtl">
          <mat-card-title>×“×•×— ×—×•×“×©×™ ×œ×¤×™ ××“×“</mat-card-title>
          <div class="mat-elevation-z4">
            <table mat-table [dataSource]="monthlyDataSource" class="mat-table" matSort #monthlySort="matSort">
              <ng-container *ngFor="let col of monthlyDisplayedColumns" [matColumnDef]="col">
                <th mat-header-cell *matHeaderCellDef>
                  {{ col === '×§×•×“ ××“×“' ? '×§×•×“ ××“×“' : col === '×©× ××“×“' ? '×©× ××“×“' : col }}
                </th>
                <td mat-cell *matCellDef="let element">
                  <ng-container *ngIf="col === '×§×•×“ ××“×“' || col === '×©× ××“×“'; else percentageCellM">
                    {{ element[col] }}
                  </ng-container>
                  <ng-template #percentageCellM>
                    <span [ngClass]="getCellClass(element[col], element['×§×•×“ ××“×“'])">
                      {{ element[col] !== null && element[col] !== undefined ? (element[col] | number:'1.0-0') + '%' : '' }}
                    </span>
                  </ng-template>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="monthlyDisplayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: monthlyDisplayedColumns;"></tr>
            </table>

            <mat-paginator #monthlyPaginator [pageSizeOptions]="[10, 20, 50]" showFirstLastButtons></mat-paginator>
          </div>
        </mat-card>
      </div>
    </mat-tab>

    <!-- === Failed Cases === -->
    <mat-tab label="×œ× ×¢××“×• ×‘××“×“">
      <div class="filter-export-row" style="display: flex; align-items: center; gap: 16px; margin: 10px 0;">
        <img src="../../assets/excel.png" alt="Download" (click)="exportFailed()" width="50px" />
        <mat-form-field appearance="outline">
          <mat-label>×—×™×¤×•×© ×›×œ×œ×™</mat-label>
          <input matInput type="text" (input)="applyGlobalFilter($event, 'failed')" placeholder="×¡× ×Ÿ ×‘×˜×‘×œ×”..." />
        </mat-form-field>
      </div>

      <mat-card class="failed-cases-card" dir="rtl">
        <mat-card-title>×¨×©×™××ª ××“×“×™× ×¢× ××•× ×” ×©×•× ×” ×-1</mat-card-title>

        <table mat-table [dataSource]="failedCasesDataSource" class="mat-elevation-z8" matSort #failedSort="matSort">

          <ng-container matColumnDef="measurment_ID">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>×§×•×“ ××“×“</th>
            <td mat-cell *matCellDef="let row">{{ row.measurment_ID }}</td>
          </ng-container>

          <ng-container matColumnDef="measurementShortDesc">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>×ª×™××•×¨</th>
            <td mat-cell *matCellDef="let row">{{ row.measurementShortDesc }}</td>
          </ng-container>

          <ng-container matColumnDef="date">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>×ª××¨×™×š</th>
            <td mat-cell *matCellDef="let row">{{ row.date | date:'dd/MM/yyyy' }}</td>
          </ng-container>

          <ng-container matColumnDef="mone">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>××•× ×”</th>
            <td mat-cell *matCellDef="let row">{{ row.mone }}</td>
          </ng-container>

          <ng-container matColumnDef="mechane">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>××›× ×”</th>
            <td mat-cell *matCellDef="let row">{{ row.mechane }}</td>
          </ng-container>

          <ng-container matColumnDef="department">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>××—×œ×§×”</th>
            <td mat-cell *matCellDef="let row">{{ row.department || '××™×Ÿ × ×ª×•× ×™×' }}</td>
          </ng-container>

          <ng-container matColumnDef="case_Number">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>××¡×¤×¨ ××§×¨×”</th>
            <td mat-cell *matCellDef="let row">{{ row.case_Number }}</td>
          </ng-container>

          <ng-container matColumnDef="remarks">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>×”×¢×¨×•×ª</th>
            <td mat-cell *matCellDef="let row">{{ row.remarks }}</td>
          </ng-container>

          <ng-container matColumnDef="entryUser">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>× ×¨×©× ×¢"×™</th>
            <td mat-cell *matCellDef="let row">{{ row.entryUser }}</td>
          </ng-container>

          <ng-container matColumnDef="entryDate">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>×ª××¨×™×š ×¨×™×©×•×</th>
            <td mat-cell *matCellDef="let row">{{ row.entryDate | date:'dd/MM/yyyy HH:mm' }}</td>
          </ng-container>

          <ng-container matColumnDef="subtract">
            <th mat-header-cell *matHeaderCellDef>×‘×§×©×” ×œ×’×¨×•×¢</th>
            <td mat-cell *matCellDef="let row">{{ row.subtract ? '×›×Ÿ' : '' }}</td>
          </ng-container>

          <ng-container matColumnDef="aprovedMabar">
            <th mat-header-cell *matHeaderCellDef>×××•×©×¨ ××‘×¨</th>
            <td mat-cell *matCellDef="let row">{{ row.aprovedMabar ? '×›×Ÿ' : '' }}</td>
          </ng-container>
          <ng-container matColumnDef="personalRequest">
            <th mat-header-cell *matHeaderCellDef> ×‘×§×©×” ×œ×”×©×’×” ×¤×¨×˜× ×™×ª</th>
            <td mat-cell *matCellDef="let row">{{ row.personalRequest ? '×›×Ÿ' : '' }}</td>
          </ng-container>
          <tr mat-header-row *matHeaderRowDef="failedCasesDisplayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: failedCasesDisplayedColumns;" (click)="openRemarksDialog(row)"></tr>
        </table>

        <mat-paginator #failedPaginator [pageSizeOptions]="[10, 20, 50]" showFirstLastButtons></mat-paginator>
      </mat-card>
    </mat-tab>

  </mat-tab-group>
</div>
