<!-- Loader (Full Page) -->
<div *ngIf="isLoading" class="loading-screen">
  <mat-progress-spinner mode="indeterminate" color="primary"></mat-progress-spinner>
  <p>אוסף נתונים לדוח מיתב....</p>
</div>

<!-- Entire Page (Hidden Until Data is Loaded) -->
<div *ngIf="!isLoading" class="body">
  <!-- Title Section -->
  <div class="nine">
    <h1>דוח מיתב</h1>
  </div>

  <!-- Filters Section -->
  <div class="filter-card">
    <div dir="rtl" class="card mat-elevation-z8">
      <div class="card-body">
        <div class="filter-container">
          <!-- Department Multi-Select -->
          <mat-form-field class="filter-field">
            <mat-label>Select Departments</mat-label>
            <mat-select [(ngModel)]="selectedDepartments" multiple (selectionChange)="applyFilters()">
              <mat-option *ngFor="let department of departmentList" [value]="department">
                {{ department }}
              </mat-option> 
            </mat-select> 
          </mat-form-field>

          <!-- Start Date Filter -->
          <mat-form-field class="filter-field">
            <mat-label>Start Date</mat-label>
            <input matInput [matDatepicker]="startDatePicker" [(ngModel)]="startDate" (ngModelChange)="applyFilters()" />
            <mat-datepicker-toggle matSuffix [for]="startDatePicker"></mat-datepicker-toggle>
            <mat-datepicker #startDatePicker></mat-datepicker>
          </mat-form-field>

          <!-- End Date Filter -->
          <mat-form-field class="filter-field">
            <mat-label>End Date</mat-label>
            <input matInput [matDatepicker]="endDatePicker" [(ngModel)]="endDate" (ngModelChange)="applyFilters()" />
            <mat-datepicker-toggle matSuffix [for]="endDatePicker"></mat-datepicker-toggle>
            <mat-datepicker #endDatePicker></mat-datepicker>
          </mat-form-field>

          <!-- Year Filter -->
          <mat-form-field class="filter-field">
            <mat-label>Select Year</mat-label>
            <mat-select [(ngModel)]="selectedYear" (selectionChange)="applyFilters()">
              <mat-option *ngFor="let year of yearList" [value]="year">
                {{ year }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Quarter Filter -->
          <mat-form-field class="filter-field">
            <mat-label>Select Quarter</mat-label>
            <mat-select [(ngModel)]="selectedQuarter" (selectionChange)="applyFilters()">
              <mat-option *ngFor="let quarter of ['Q1', 'Q2', 'Q3', 'Q4']" [value]="quarter">
                {{ quarter }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Filter Buttons -->
          <div class="filter-buttons" style="margin-top: 10px; text-align: right;">
            <button mat-raised-button color="warn" (click)="resetFilters()">Reset</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Gauge Section -->
  <div class="gauge-section">
    <mat-card class="gauge-card">
      <div class="gauge-title">Mobility Grade Distribution</div>
      <div class="gauge-content">
        <ngx-gauge
          [value]="gaugeValue"
          [min]="0"
          [max]="100"
          [label]="'Mobility Percentage'"
          [append]="'%'"
          [foregroundColor]="getGaugeColor()"> 
        </ngx-gauge>
        <div class="gauge-info">
          <strong>Overall Mobility Percentage: {{ gaugeValue | number:'1.1-1' }}%</strong>
        </div>
      </div>
      <button mat-raised-button color="primary" (click)="openDepartmentPercentagesDialog()">
        View Department Percentages
      </button>
    </mat-card>
  </div>

  <!-- Tabs Section -->
  <mat-tab-group dir="rtl">
    <mat-tab label="ניידות">
      <div class="table-section" dir="rtl">
        <table mat-table [dataSource]="dataSource" matSort>
          <ng-container *ngFor="let column of displayedColumns" [matColumnDef]="column">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>{{ column }}</th>
            <td mat-cell *matCellDef="let element">
              <ng-container *ngIf="column === 'AdmissionDate' || column === 'ReleaseDate'; else normalColumn">
                {{ element[column] | date:'dd/MM/yyyy' }}
              </ng-container>
              <ng-template #normalColumn>
                {{ element[column] }}
              </ng-template>
            </td>
          </ng-container>
          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
        <mat-paginator [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons></mat-paginator>
      </div>
    </mat-tab>

    <!-- Additional Table Placeholder -->
    <mat-tab label="Additional Table"></mat-tab>
  </mat-tab-group>
</div>
