<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />

<div class="body">

<!-- כרטיס גרף Top-5 -->
<mat-card class="chart-card" dir="rtl">
    <div class="chart-card__head">
      <div class="chart-title">Top-5 Routes</div>
      <mat-button-toggle-group [value]="period" (change)="periodChanged($event.value)">
        <mat-button-toggle value="today">היום</mat-button-toggle>
        <mat-button-toggle value="month">החודש</mat-button-toggle>
        <mat-button-toggle value="all">כל הזמנים</mat-button-toggle>
      </mat-button-toggle-group>
    </div>
  
    <div class="chart-wrapper">
      <canvas #topChart></canvas>
    </div>
  </mat-card>

  <!-- ===== Tabs ===== -->
  <mat-tab-group>
    <!-- Tab 1: rows table -->
    <mat-tab label="לוגים">
      <!-- Filters (same structure/classes) -->
      <form [formGroup]="filterForm" dir="rtl" class="filter-form">
        <div dir="rtl" class="form-footer" style="display: flex; justify-content: space-between;">
          <mat-form-field class="long-search-bar" style="flex: 1; margin-right: 10px;">
            <mat-label class="filters" style="color: blue">חיפוש</mat-label>
            <input matInput formControlName="globalFilter" class="search-input" />
          </mat-form-field>

          <div class="button-container" style="display: flex; align-items: center;">
            <button mat-button (click)="resetFilters()" mat-raised-button color="primary"
                    class="custom-button" matTooltip="איפוס">
              <i class="material-icons">refresh</i>
            </button>
            <img src="../../assets/excel.png" alt="Download" (click)="exportToExcel()"
                 class="download-icon icon" width="50px" style="margin-right: 10px;" />
          </div>
        </div>
      </form>

      <mat-progress-bar *ngIf="isLoading" mode="indeterminate"></mat-progress-bar>

      <table mat-table [dataSource]="dataSource" matSort class="mat-elevation-z8" >

        <ng-container matColumnDef="tsUtc">
          <mat-header-cell *matHeaderCellDef mat-sort-header> תאריך/שעה (UTC) </mat-header-cell>
          <mat-cell *matCellDef="let element"> {{ element.tsUtcDate | date:'dd/MM/yyyy HH:mm' }} </mat-cell>
        </ng-container>

        <ng-container matColumnDef="route">
          <mat-header-cell *matHeaderCellDef mat-sort-header> Route </mat-header-cell>
          <mat-cell *matCellDef="let element"> {{ element.route }} </mat-cell>
        </ng-container>

        <ng-container matColumnDef="clientIp">
          <mat-header-cell *matHeaderCellDef mat-sort-header> IP </mat-header-cell>
          <mat-cell *matCellDef="let element"> {{ element.clientIp || '—' }} </mat-cell>
        </ng-container>

        <ng-container matColumnDef="host">
          <mat-header-cell *matHeaderCellDef mat-sort-header> Host </mat-header-cell>
          <mat-cell *matCellDef="let element"> {{ element.host || '—' }} </mat-cell>
        </ng-container>

        <ng-container matColumnDef="userAgent">
          <mat-header-cell *matHeaderCellDef> User-Agent </mat-header-cell>
          <mat-cell *matCellDef="let element">
            <span title="{{ element.userAgent }}">{{ element.userAgent || '—' }}</span>
          </mat-cell>
        </ng-container>

        <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
        <mat-row *matRowDef="let row; columns: displayedColumns;"></mat-row>
      </table>

      <mat-paginator [pageSize]="10" [pageSizeOptions]="[10, 25, 50]" showFirstLastButtons></mat-paginator>
    </mat-tab>

    <!-- Tab 2: counts per route (today / month / total) -->
    <mat-tab label="סיכום ">
      <div dir="rtl" class="filter-form" style="margin: 10px 0;">
        <div class="form-footer" style="display: flex; justify-content: space-between;">
          <mat-form-field class="long-search-bar" style="flex: 1;">
            <mat-label class="filters">חיפוש במסכמים</mat-label>
            <input matInput #countsSearch (input)="applyCountsFilter(countsSearch.value)" />
        </mat-form-field>
        </div>
      </div>

      <table mat-table [dataSource]="dataSourceCounts" matSort #countsSort="matSort" class="mat-elevation-z8" dir="rtl">

        <!-- route column cell in the summary table -->
<!-- Title column -->
<ng-container matColumnDef="title">
  <mat-header-cell *matHeaderCellDef mat-sort-header> כותרת </mat-header-cell>
  <mat-cell *matCellDef="let e">
    <span>{{ e.title || '—' }}</span>
  </mat-cell>
</ng-container>
<!-- Route column (with chips) -->
<ng-container matColumnDef="route">
  <mat-header-cell *matHeaderCellDef mat-sort-header> Route </mat-header-cell>
  <mat-cell *matCellDef="let e">
    <span class="route-path">{{ e.route }}</span>
    <span *ngIf="e.isMissing" class="chip chip-warn">לא בשימוש</span>
    <span *ngIf="e.isUnknown" class="chip chip-accent">לא ברואטר</span>
  </mat-cell>
</ng-container>

        <ng-container matColumnDef="today">
          <mat-header-cell *matHeaderCellDef mat-sort-header> היום </mat-header-cell>
          <mat-cell *matCellDef="let element"> {{ element.today | number:'1.0-0' }} </mat-cell>
        </ng-container>

        <ng-container matColumnDef="month">
          <mat-header-cell *matHeaderCellDef mat-sort-header> חודש זה </mat-header-cell>
          <mat-cell *matCellDef="let element"> {{ element.month | number:'1.0-0' }} </mat-cell>
        </ng-container>

        <ng-container matColumnDef="total">
          <mat-header-cell *matHeaderCellDef mat-sort-header> סה״כ </mat-header-cell>
          <mat-cell *matCellDef="let element"> {{ element.total | number:'1.0-0' }} </mat-cell>
        </ng-container>

        <mat-header-row *matHeaderRowDef="displayedColumnsCounts"></mat-header-row>
        <mat-row *matRowDef="let row; columns: displayedColumnsCounts;"></mat-row>
      </table>

      <mat-paginator #countsPaginator [pageSize]="10" [pageSizeOptions]="[10, 25, 50]" showFirstLastButtons></mat-paginator>
    </mat-tab>
    
  </mat-tab-group>
</div>
