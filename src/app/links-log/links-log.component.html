<div class="body">
<!-- Text KPIs comparing same-length periods to last year (MTD/QTD/YTD aligned) -->
<!-- DEBUG: show raw JSON to confirm binding -->
<pre style="direction:ltr; font-size:11px; background:#f7f7f7; padding:6px; border:1px dashed #ccc;"
     *ngIf="kpiCmp">{{ kpiCmp | json }}</pre>

<!-- KPIs (compare to last year). 'as k' avoids ?. everywhere -->
<div class="kpi-text" dir="rtl" *ngIf="kpiCmp as k"
     style="display:flex; gap:18px; flex-wrap:wrap; margin:8px 0 12px;">

  <!-- Today -->
  <div class="kpi-chip" [ngClass]="trendClass(k.Today, k.TodayLY)"
       style="padding:10px 14px; border-radius:10px; border:1px solid rgba(0,0,0,.12);">
    <div style="font-weight:600;">היום</div>
    <div>
      {{ k.Today | number }}
      <span>&nbsp;(<span [ngClass]="trendClass(k.Today, k.TodayLY)">
        {{ delta(k.Today, k.TodayLY) }}%
      </span> מול שנה שעברה)</span>
    </div>
  </div>

  <!-- Month-to-date -->
  <div class="kpi-chip" [ngClass]="trendClass(k.ThisMonth, k.ThisMonthLY)"
       style="padding:10px 14px; border-radius:10px; border:1px solid rgba(0,0,0,.12);">
    <div style="font-weight:600;">החודש (עד היום)</div>
    <div>
      {{ k.ThisMonth | number }}
      <span>&nbsp;(<span [ngClass]="trendClass(k.ThisMonth, k.ThisMonthLY)">
        {{ delta(k.ThisMonth, k.ThisMonthLY) }}%
      </span> מול שנה שעברה)</span>
    </div>
  </div>

  <!-- Quarter-to-date -->
  <div class="kpi-chip" [ngClass]="trendClass(k.ThisQuarter, k.ThisQuarterLY)"
       style="padding:10px 14px; border-radius:10px; border:1px solid rgba(0,0,0,.12);">
    <div style="font-weight:600;">הרבעון (עד היום)</div>
    <div>
      {{ k.ThisQuarter | number }}
      <span>&nbsp;(<span [ngClass]="trendClass(k.ThisQuarter, k.ThisQuarterLY)">
        {{ delta(k.ThisQuarter, k.ThisQuarterLY) }}%
      </span> מול שנה שעברה)</span>
    </div>
  </div>
</div>

  
  
  
    <!-- ===== Filters OUTSIDE the tab group ===== -->
    <ng-container [ngSwitch]="selectedTab">
  
      <!-- TAB 0 filters: Summary -->
      <form *ngSwitchCase="0" [formGroup]="filterForm" dir="rtl" class="filter-form">
        <!-- <button mat-raised-button color="primary" (click)="fetchSummaryData()" [disabled]="loadingSummary">הפעל</button>
  
        <mat-form-field>
          <mat-label>תאריך התחלה</mat-label>
          <input matInput [matDatepicker]="startSummaryPicker" formControlName="fromDate" />
          <mat-datepicker-toggle matSuffix [for]="startSummaryPicker"></mat-datepicker-toggle>
          <mat-datepicker #startSummaryPicker></mat-datepicker>
        </mat-form-field>
  
        <mat-form-field>
          <mat-label>תאריך סיום</mat-label>
          <input matInput [matDatepicker]="endSummaryPicker" formControlName="toDate" />
          <mat-datepicker-toggle matSuffix [for]="endSummaryPicker"></mat-datepicker-toggle>
          <mat-datepicker #endSummaryPicker></mat-datepicker>
        </mat-form-field> -->
  
        <div dir="rtl" class="form-footer" style="display:flex;justify-content:space-between;">
          <mat-form-field class="long-search-bar" style="flex:1;margin-right:10px;">
            <mat-label class="filters" style="color:blue">חיפוש</mat-label>
            <input matInput formControlName="globalFilter" placeholder="Search..." />
          </mat-form-field>
  
          <div class="button-container" style="display:flex;align-items:center;">
            <button mat-button (click)="resetSummaryFilters()" mat-raised-button color="primary" class="custom-button" matTooltip="Reset Filters">
              <i class="material-icons">refresh</i>
            </button>
  
          </div>
        </div>
      </form>
  
      <!-- TAB 1 filters: Period Totals -->
      <form *ngSwitchCase="1" [formGroup]="totalsForm" dir="rtl" class="filter-form">
        <!-- <button mat-raised-button color="primary" (click)="fetchTotalsData()" [disabled]="loadingTotals">הפעל</button>
  
        <mat-form-field>
          <mat-label>תאריך התחלה</mat-label>
          <input matInput [matDatepicker]="startTotalsPicker" formControlName="dummyStart" />
          <mat-datepicker-toggle matSuffix [for]="startTotalsPicker"></mat-datepicker-toggle>
          <mat-datepicker #startTotalsPicker></mat-datepicker>
        </mat-form-field>
  
        <mat-form-field>
          <mat-label>תאריך סיום</mat-label>
          <input matInput [matDatepicker]="endTotalsPicker" formControlName="dummyEnd" />
          <mat-datepicker-toggle matSuffix [for]="endTotalsPicker"></mat-datepicker-toggle>
          <mat-datepicker #endTotalsPicker></mat-datepicker>
        </mat-form-field> -->
  
        <div dir="rtl" class="form-footer" style="display:flex;justify-content:space-between;">
          <mat-form-field class="long-search-bar" style="flex:1;margin-right:10px;">
            <mat-label class="filters" style="color:blue">חיפוש</mat-label>
            <input matInput formControlName="globalFilter" placeholder="Search..." />
          </mat-form-field>
  
          <div class="button-container" style="display:flex;align-items:center;">
            <button mat-button (click)="resetTotalsFilters()" mat-raised-button color="primary" class="custom-button" matTooltip="Reset Filters">
              <i class="material-icons">refresh</i>
            </button>
  
          </div>
        </div>
      </form>
  
    </ng-container>
    <!-- ===== /Filters OUTSIDE ===== -->
  
    <!-- Tabs only contain the tables + paginators -->
    <mat-tab-group [(selectedIndex)]="selectedTab">
      <!-- TAB 0: Summary -->
      <mat-tab label="סיכום משתמש/רבעון">
        <mat-progress-bar *ngIf="loadingSummary" mode="indeterminate"></mat-progress-bar>
  
        <mat-table [dataSource]="matTableDataSource" matSort #sortSummary="matSort" dir="rtl" class="mat-elevation-z8">
          <ng-container matColumnDef="linkDescription">
            <mat-header-cell *matHeaderCellDef mat-sort-header> תיאור קישור </mat-header-cell>
            <mat-cell *matCellDef="let r"> {{ r.linkDescription }} </mat-cell>
          </ng-container>
  
          <ng-container matColumnDef="linkId">
            <mat-header-cell *matHeaderCellDef mat-sort-header> LinkId </mat-header-cell>
            <mat-cell *matCellDef="let r"><code>{{ r.linkId }}</code></mat-cell>
          </ng-container>
  
          <ng-container matColumnDef="employee_Name">
            <mat-header-cell *matHeaderCellDef mat-sort-header> עובד </mat-header-cell>
            <mat-cell *matCellDef="let r"> {{ r.employee_Name }} </mat-cell>
          </ng-container>
  
          <ng-container matColumnDef="period">
            <mat-header-cell *matHeaderCellDef mat-sort-header> תקופה </mat-header-cell>
            <mat-cell *matCellDef="let r"> Q{{ r.tq }} {{ r.ty }} </mat-cell>
          </ng-container>
  
          <ng-container matColumnDef="userCountPerLink">
            <mat-header-cell *matHeaderCellDef mat-sort-header> ספירה </mat-header-cell>
            <mat-cell *matCellDef="let r"> {{ r.userCountPerLink | number }} </mat-cell>
          </ng-container>
  
          <mat-header-row *matHeaderRowDef="columns"></mat-header-row>
          <mat-row *matRowDef="let row; columns: columns"></mat-row>
        </mat-table>
  
        <mat-paginator
          #paginatorSummary
          [length]="totalResults"
          [pageSizeOptions]="[5, 50, 100]"
          showFirstLastButtons>
        </mat-paginator>
      </mat-tab>
  
      <!-- TAB 1: Period Totals -->
      <mat-tab label="סיכומי תקופות">
        <mat-progress-bar *ngIf="loadingTotals" mode="indeterminate"></mat-progress-bar>
  
        <mat-table [dataSource]="matTableDataSourceTotals" matSort #sortTotals="matSort" dir="rtl" class="mat-elevation-z8">
          <ng-container matColumnDef="linkDescription">
            <mat-header-cell *matHeaderCellDef mat-sort-header> תיאור קישור </mat-header-cell>
            <mat-cell *matCellDef="let r"> {{ r.linkDescription }} </mat-cell>
          </ng-container>
  
          <ng-container matColumnDef="today">
            <mat-header-cell *matHeaderCellDef mat-sort-header> היום </mat-header-cell>
            <mat-cell *matCellDef="let r"> {{ r.today }} </mat-cell>
          </ng-container>
  
          <ng-container matColumnDef="thisMonth">
            <mat-header-cell *matHeaderCellDef mat-sort-header> החודש </mat-header-cell>
            <mat-cell *matCellDef="let r"> {{ r.thisMonth }} </mat-cell>
          </ng-container>
  
          <ng-container matColumnDef="thisQuarter">
            <mat-header-cell *matHeaderCellDef mat-sort-header> רבעון </mat-header-cell>
            <mat-cell *matCellDef="let r"> {{ r.thisQuarter }} </mat-cell>
          </ng-container>
  
          <ng-container matColumnDef="thisYear">
            <mat-header-cell *matHeaderCellDef mat-sort-header> השנה </mat-header-cell>
            <mat-cell *matCellDef="let r"> {{ r.thisYear }} </mat-cell>
          </ng-container>
  
          <ng-container matColumnDef="allTime">
            <mat-header-cell *matHeaderCellDef mat-sort-header> כל הזמנים </mat-header-cell>
            <mat-cell *matCellDef="let r"> {{ r.allTime }} </mat-cell>
          </ng-container>
  
          <mat-header-row *matHeaderRowDef="totalsColumns"></mat-header-row>
          <mat-row *matRowDef="let row; columns: totalsColumns"></mat-row>
        </mat-table>
  
        <mat-paginator
          #paginatorTotals
          [length]="totalResultsTotals"
          [pageSizeOptions]="[5, 50, 100]"
          showFirstLastButtons>
        </mat-paginator>
      </mat-tab>
    </mat-tab-group>
  
  </div>
  